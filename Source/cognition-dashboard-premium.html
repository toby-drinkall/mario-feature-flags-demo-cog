<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Management Dashboard</title>
    <!-- v1.8 - Active polling for Check Merge -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10/dist/framer-motion.js"></script>
    <script src="devin-api-config.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Dark mode */
        .dark body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        .dark body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(74, 86, 226, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .dark body::after {
            content: '';
            position: fixed;
            inset: 0;
            background:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.02) 2px, rgba(255,255,255,0.02) 4px);
            pointer-events: none;
            z-index: 0;
        }

        /* Light mode - Crisp and clean with strong contrast */
        .light body {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #f1f3f5 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        .light body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .light body::after {
            content: '';
            position: fixed;
            inset: 0;
            background:
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.01) 2px, rgba(0,0,0,0.01) 4px);
            pointer-events: none;
            z-index: 0;
        }

        /* Ensure content is above background patterns */
        #root {
            position: relative;
            z-index: 1;
        }

        /* Dark mode cards */
        .dark .glass-card {
            background: rgba(26, 26, 46, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .dark .glass-card:hover {
            background: rgba(26, 26, 46, 0.7);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Light mode cards */
        .light .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.12);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                0 1px 3px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .light .glass-card:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(0, 0, 0, 0.16);
            transform: translateY(-2px);
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.12),
                0 2px 6px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .badge-glow {
            box-shadow: 0 0 20px currentColor;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Status badges - Light mode improvements */
        .light .bg-emerald-500\/20 {
            background: rgba(16, 185, 129, 0.15) !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
        }
        .light .text-emerald-400 {
            color: #10b981 !important;
            font-weight: 600;
        }
        .light .bg-emerald-400 {
            background: #10b981 !important;
        }

        .light .bg-amber-500\/20 {
            background: rgba(245, 158, 11, 0.15) !important;
            border-color: rgba(245, 158, 11, 0.3) !important;
        }
        .light .text-amber-400 {
            color: #f59e0b !important;
            font-weight: 600;
        }
        .light .bg-amber-400 {
            background: #f59e0b !important;
        }

        .light .bg-blue-500\/20 {
            background: rgba(59, 130, 246, 0.15) !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
        }
        .light .text-blue-400 {
            color: #3b82f6 !important;
            font-weight: 600;
        }

        .light .bg-gray-500\/20 {
            background: rgba(100, 116, 139, 0.12) !important;
            border-color: rgba(100, 116, 139, 0.25) !important;
        }
        .light .text-gray-400 {
            color: #64748b !important;
            font-weight: 600;
        }

        /* Primary gradient buttons - Enhanced for light mode */
        .light .bg-gradient-to-r.from-blue-500 {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%) !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3),
                        0 2px 6px rgba(139, 92, 246, 0.2);
        }

        .light .bg-gradient-to-r.from-blue-500:hover {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%) !important;
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35),
                        0 3px 8px rgba(124, 58, 237, 0.25);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom scrollbar - Dark mode */
        .dark ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .dark ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .dark ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Custom scrollbar - Light mode */
        .light ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .light ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .light ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .light ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Tab styles - Simple border-bottom design */
        .tab-container {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .light .tab-container {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        .dark .tab-button {
            position: relative;
            padding: 1rem 0;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .dark .tab-button:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .dark .tab-button.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
            font-weight: 600;
        }

        .light .tab-button {
            position: relative;
            padding: 1rem 0;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(15, 23, 42, 0.5);
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .light .tab-button:hover {
            color: rgba(15, 23, 42, 0.9);
        }

        .light .tab-button.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
        }

        /* Text colors */
        .dark .text-primary { color: #fff; }
        .dark .text-secondary { color: rgba(255, 255, 255, 0.7); }
        .dark .text-tertiary { color: rgba(255, 255, 255, 0.5); }

        .light .text-primary { color: #0f172a; }
        .light .text-secondary { color: #475569; }
        .light .text-tertiary { color: #94a3b8; }

        /* Toggle switch - Dark mode */
        .dark .toggle-track {
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }

        .dark .toggle-track.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            box-shadow: 0 0 12px rgba(102, 126, 234, 0.4);
        }

        /* Toggle switch - Light mode */
        .light .toggle-track {
            width: 44px;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #cbd5e1;
            display: flex;
            align-items: center;
        }

        .light .toggle-track.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-color: transparent;
            box-shadow: 0 0 16px rgba(79, 70, 229, 0.4),
                        0 2px 8px rgba(79, 70, 229, 0.25);
        }

        .toggle-thumb {
            position: absolute;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-track.active .toggle-thumb {
            left: 22px;
        }

        /* Category colors - Dark mode */
        .dark .category-movement { color: #c084fc; }
        .dark .category-visual { color: #22d3ee; }
        .dark .category-gameplay { color: #fb923c; }
        .dark .category-character { color: #f472b6; }

        /* Category colors - Light mode (vibrant neon) */
        .light .category-movement { color: #a855f7; font-weight: 600; }
        .light .category-visual { color: #06b6d4; font-weight: 600; }
        .light .category-gameplay { color: #f97316; font-weight: 600; }
        .light .category-character { color: #ec4899; font-weight: 600; }

        /* Button colors - Light mode adjustments */
        .light .btn-remove {
            color: #ef4444;
            font-weight: 600;
        }
        .light .btn-remove:hover {
            color: #dc2626;
            background: rgba(239, 68, 68, 0.12);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.15);
        }

        .light .btn-recover {
            color: #3b82f6;
            font-weight: 600;
        }
        .light .btn-recover:hover {
            color: #2563eb;
            background: rgba(59, 130, 246, 0.12);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.15);
        }

        /* Stats number colors - make blue and red more vibrant in light mode */
        .light .stat-blue { color: #3b82f6; }
        .light .stat-red { color: #ef4444; }

        /* Enable button - styled like Remove but blue */
        .dark .btn-enable {
            color: #60a5fa;
        }
        .dark .btn-enable:hover {
            color: #93c5fd;
            background: rgba(96, 165, 250, 0.1);
        }

        .light .btn-enable {
            color: #2563eb;
        }
        .light .btn-enable:hover {
            color: #1d4ed8;
            background: rgba(37, 99, 235, 0.1);
        }

        /* Disable button - neon orange */
        .dark .btn-disable {
            color: #fb923c;
        }
        .dark .btn-disable:hover {
            color: #fdba74;
            background: rgba(251, 146, 60, 0.1);
        }

        .light .btn-disable {
            color: #ea580c;
        }
        .light .btn-disable:hover {
            color: #c2410c;
            background: rgba(234, 88, 12, 0.1);
        }

        /* Permanent enable button - neon green */
        .dark .btn-permanent-enable {
            color: #10b981;
        }
        .dark .btn-permanent-enable:hover {
            color: #34d399;
            background: rgba(16, 185, 129, 0.1);
        }

        .light .btn-permanent-enable {
            color: #059669;
            font-weight: 600;
        }
        .light .btn-permanent-enable:hover {
            color: #047857;
            background: rgba(5, 150, 105, 0.1);
        }

        /* Mario Bros title */
        .mario-title {
            font-family: 'Press Start 2P', 'Press Start', cursive, monospace;
            font-size: 28px;
            font-weight: bold;
            color: #ff0000;
            text-shadow:
                3px 3px 0 #8b0000,
                4px 4px 0 #000,
                -1px -1px 0 #ff6b6b,
                1px 1px 0 #ff6b6b;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .dark .mario-title {
            color: #ff0000;
        }

        .light .mario-title {
            color: #dc2626;
            text-shadow:
                2px 2px 0 #7f1d1d,
                3px 3px 0 #000,
                -1px -1px 0 #fca5a5,
                1px 1px 0 #fca5a5;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion, AnimatePresence } = window.framerMotion || {};

        // Lucide icons setup
        lucide.createIcons();

        // Theme management
        const useTheme = () => {
            const [isDark, setIsDark] = useState(() => {
                const saved = localStorage.getItem('theme');
                return saved ? saved === 'dark' : false;
            });

            useEffect(() => {
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                document.documentElement.classList.toggle('dark', isDark);
                document.documentElement.classList.toggle('light', !isDark);
            }, [isDark]);

            return [isDark, setIsDark];
        };

        // Feature data
        const modsData = [
            { name: "Bouncy Bounce", description: "Mario landing causes him to jump.", file: "Source/settings/mods.js", lineStart: 5, lineEnd: 35, lines: 31, category: "movement" },
            { name: "Dark is the Night", description: "Dark theme visual.", file: "Source/settings/mods.js", lineStart: 37, lineEnd: 82, lines: 46, category: "visual" },
            { name: "Earthquake!", description: "Mario landing causes everything to jump.", file: "Source/settings/mods.js", lineStart: 84, lineEnd: 158, lines: 75, category: "movement" },
            { name: "Gradient Skies", description: "Smooth gradient backgrounds.", file: "Source/settings/mods.js", lineStart: 160, lineEnd: 245, lines: 86, category: "visual" },
            { name: "Hard Mode", description: "Harder enemies and faster gameplay.", file: "Source/settings/mods.js", lineStart: 247, lineEnd: 338, lines: 92, category: "gameplay" },
            { name: "High Speed", description: "Mario runs 14x faster.", file: "Source/settings/mods.js", lineStart: 340, lineEnd: 372, lines: 33, category: "movement" },
            { name: "Infinite Lives", description: "Lives never decrease.", file: "Source/settings/mods.js", lineStart: 374, lineEnd: 410, lines: 37, category: "gameplay" },
            { name: "Invincibility", description: "Permanent star power.", file: "Source/settings/mods.js", lineStart: 412, lineEnd: 440, lines: 29, category: "gameplay" },
            { name: "Parallax Clouds", description: "Clouds scroll at 70% speed.", file: "Source/settings/mods.js", lineStart: 442, lineEnd: 456, lines: 15, category: "visual" },
            { name: "Low Gravity", description: "Reduced gravity.", file: "Source/settings/mods.js", lineStart: 458, lineEnd: 474, lines: 17, category: "movement" },
            { name: "Luigi", description: "Play as Luigi.", file: "Source/settings/mods.js", lineStart: 476, lineEnd: 507, lines: 32, category: "character" },
            { name: "Tilt Gravity", description: "Device motion controls gravity.", file: "Source/settings/mods.js", lineStart: 509, lineEnd: 550, lines: 42, category: "movement" },
            { name: "Palette Swap", description: "Random color palettes.", file: "Source/settings/mods.js", lineStart: 552, lineEnd: 616, lines: 65, category: "visual" },
            { name: "QCount", description: "Press Q to spawn enemies.", file: "Source/settings/mods.js", lineStart: 618, lineEnd: 689, lines: 72, category: "gameplay" },
            { name: "Super Fireballs", description: "Fireballs destroy blocks.", file: "Source/settings/mods.js", lineStart: 691, lineEnd: 707, lines: 17, category: "gameplay" }
        ];

        // Feature Flags data - actual features from the codebase
        const featureFlagsData = [
            {
                name: "jumpmod",
                displayName: "jumpmod",
                description: "Physics constant (1.056) controlling Mario's jump height (lower = jump higher)",
                file: "Source/settings/objects.js",
                lineStart: 230,
                lineEnd: 230,
                lines: 1,
                category: "physics",
                filesAffected: [
                    { file: "Source/settings/objects.js", lineStart: 230, lineEnd: 230, lines: 1 },
                    { file: "Source/settings/math.ts", lineStart: 12, lineEnd: 14, lines: 3 },
                    { file: "Source/settings/math.js", lineStart: 31, lineEnd: 31, lines: 1 },
                    { file: "Source/settings/maps.js", lineStart: 12, lineEnd: 12, lines: 1 },
                    { file: "Source/FullScreenMario.d.ts", lineStart: 7, lineEnd: 7, lines: 1 }
                ],
                enabled: true, // Currently active in the codebase
                currentValue: "1.056"
            },
            {
                name: "gravity",
                displayName: "gravity",
                description: "Gravity constant controlling fall speed (lower = float more, higher = fall faster)",
                file: "Source/settings/objects.js",
                lineStart: 235,
                lineEnd: 235,
                lines: 1,
                category: "physics",
                filesAffected: [
                    { file: "Source/settings/objects.js", lineStart: 235, lineEnd: 235, lines: 1 },
                    { file: "Source/settings/maps.js", lineStart: 33, lineEnd: 40, lines: 8 },
                    { file: "Source/settings/ui.js", lineStart: 111, lineEnd: 115, lines: 5 },
                    { file: "Source/FullScreenMario.ts", lineStart: 64, lineEnd: 64, lines: 1 },
                    { file: "Source/FullScreenMario.ts", lineStart: 938, lineEnd: 6308, lines: 8 },
                    { file: "Source/FullScreenMario.d.ts", lineStart: 1, lineEnd: 1, lines: 1 }
                ],
                enabled: true,
                currentValue: "0.48"
            },
            {
                name: "maxspeed",
                displayName: "maxspeed",
                description: "Maximum running speed for Mario (higher = faster, lower = slower)",
                file: "Source/settings/objects.js",
                lineStart: 330,
                lineEnd: 330,
                lines: 1,
                category: "movement",
                filesAffected: [
                    { file: "Source/settings/objects.js", lineStart: 330, lineEnd: 331, lines: 2 },
                    { file: "Source/settings/mods.js", lineStart: 1, lineEnd: 1, lines: 1 },
                    { file: "Source/FullScreenMario.ts", lineStart: 1, lineEnd: 1, lines: 1 },
                    { file: "Source/FullScreenMario.d.ts", lineStart: 1, lineEnd: 1, lines: 1 }
                ],
                enabled: true,
                currentValue: "5.4"
            },
            {
                name: "walkspeed",
                displayName: "walkspeed",
                description: "Base walking speed for Mario (higher = faster walk, lower = slower walk)",
                file: "Source/settings/objects.js",
                lineStart: 329,
                lineEnd: 329,
                lines: 1,
                category: "movement",
                filesAffected: [
                    { file: "Source/settings/objects.js", lineStart: 329, lineEnd: 329, lines: 1 },
                    { file: "Source/FullScreenMario.ts", lineStart: 1, lineEnd: 1, lines: 1 },
                    { file: "Source/FullScreenMario.d.ts", lineStart: 1, lineEnd: 1, lines: 1 }
                ],
                enabled: true,
                currentValue: "2.0"
            }
        ];

        const removalSteps = [
            { id: 'init', label: 'Initializing Devin session', duration: 800 },
            { id: 'locate', label: 'Locating feature flag', duration: 1500 },
            { id: 'backup', label: 'Creating backup', duration: 600 },
            { id: 'remove', label: 'Removing feature flag code', duration: 2000 },
            { id: 'test', label: 'Running test suite', duration: 3500 },
            { id: 'branch', label: 'Creating git branch', duration: 800 },
            { id: 'commit', label: 'Committing changes', duration: 1000 },
            { id: 'pr', label: 'Creating Pull Request', duration: 1500 },
            { id: 'complete', label: 'Finalizing automation', duration: 800 }
        ];

        const replacementSteps = [
            { id: 'init', label: 'Initializing Devin session', duration: 800 },
            { id: 'analyze', label: 'Analyzing codebase', duration: 1000 },
            { id: 'backup', label: 'Creating backups', duration: 800 },
            { id: 'remove_old_constant', label: 'Removing old constant completely', duration: 1500 },
            { id: 'add_new_constant', label: 'Adding new constant', duration: 1200 },
            { id: 'update_references', label: 'Updating code references', duration: 2000 },
            { id: 'test', label: 'Running tests', duration: 3500 },
            { id: 'pr', label: 'Creating atomic PR', duration: 1500 },
            { id: 'complete', label: 'Finalizing automation', duration: 800 }
        ];

        const recoverySteps = [
            { id: 'init', label: 'Initializing Devin session', duration: 800 },
            { id: 'load', label: 'Loading feature backup', duration: 1000 },
            { id: 'analyze_pr', label: 'Analyzing removal PR', duration: 1200 },
            { id: 'restore', label: 'Restoring feature code', duration: 2000 },
            { id: 'test', label: 'Running test suite', duration: 3000 },
            { id: 'branch', label: 'Creating recovery branch', duration: 800 },
            { id: 'pr', label: 'Creating Pull Request', duration: 1500 }
        ];

        const featureFlagRecoverySteps = [
            { id: 'init', label: 'Initializing Devin session', duration: 800 },
            { id: 'load_backup', label: 'Loading original constant backup', duration: 1000 },
            { id: 'identify_replacement', label: 'Identifying replacement constant', duration: 1000 },
            { id: 'remove_replacement', label: 'Removing replacement completely', duration: 1500 },
            { id: 'restore_original', label: 'Restoring original constant', duration: 1200 },
            { id: 'update_references', label: 'Updating code references', duration: 2000 },
            { id: 'test', label: 'Running tests', duration: 3500 },
            { id: 'pr', label: 'Creating atomic PR', duration: 1500 },
            { id: 'complete', label: 'Finalizing automation', duration: 800 }
        ];

        const enableSteps = [
            { id: 'init', label: 'Initializing Devin session', duration: 800 },
            { id: 'analyze', label: 'Analyzing feature structure', duration: 1500 },
            { id: 'backup', label: 'Creating feature backup', duration: 600 },
            { id: 'enable', label: 'Adding feature to game UI', duration: 2000 },
            { id: 'test', label: 'Running test suite', duration: 3500 },
            { id: 'branch', label: 'Creating git branch', duration: 800 },
            { id: 'commit', label: 'Committing changes', duration: 1000 },
            { id: 'pr', label: 'Creating Pull Request', duration: 1500 }
        ];

        const returnToStagingSteps = [
            { id: 'init', label: 'Initializing Devin session', duration: 800 },
            { id: 'load', label: 'Loading feature backup', duration: 1000 },
            { id: 'analyze_pr', label: 'Analyzing enable PR', duration: 1200 },
            { id: 'restore', label: 'Restoring to staging state', duration: 2000 },
            { id: 'test', label: 'Running test suite', duration: 3000 },
            { id: 'branch', label: 'Creating restore branch', duration: 800 },
            { id: 'pr', label: 'Creating Pull Request', duration: 1500 }
        ];

        let prCounter = parseInt(localStorage.getItem('pr_counter') || '122');
        function getNextPR() {
            prCounter++;
            localStorage.setItem('pr_counter', prCounter.toString());
            return prCounter;
        }

        function isDevinAPIConfigured() {
            const configured = window.DevinAPI &&
                   window.DevinAPI.config.apiUrl !== 'YOUR_DEVIN_API_URL' &&
                   window.DevinAPI.config.apiKey !== 'YOUR_API_KEY';
            return configured;
        }

        // Components
        function StatusBadge({ connected, devinIntegrated }) {
            return (
                <div className="flex items-center gap-3">
                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium ${
                        connected
                            ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'
                            : 'bg-amber-500/20 text-amber-400 border border-amber-500/30'
                    }`}>
                        <div className={`w-2 h-2 rounded-full ${connected ? 'bg-emerald-400 badge-glow' : 'bg-amber-400 animate-pulse'}`} />
                        {connected ? 'Game Connected' : 'Waiting for Connection'}
                    </div>
                    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium ${
                        devinIntegrated
                            ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30'
                            : 'bg-gray-500/20 text-gray-400 border border-gray-500/30'
                    }`}>
                        <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/>
                        </svg>
                        {devinIntegrated ? 'Devin API Ready' : 'Simulation Mode'}
                    </div>
                </div>
            );
        }

        function FeatureCard({ feature, enabled, onToggle, onEnable, onRemove, connected }) {
            const categoryColors = {
                movement: 'category-movement',
                visual: 'category-visual',
                gameplay: 'category-gameplay',
                character: 'category-character'
            };

            return (
                <div className="glass-card rounded-2xl p-4 flex items-center justify-between group">
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                            <h3 className="text-sm font-semibold text-primary truncate">{feature.name}</h3>
                            <span className={`text-[10px] uppercase tracking-wider ${categoryColors[feature.category]} opacity-70`}>
                                {feature.category}
                            </span>
                        </div>
                        <p className="text-xs text-secondary truncate">{feature.description}</p>
                        <div className="text-[10px] text-tertiary mt-1">{feature.lines} lines</div>
                    </div>
                    <div className="flex items-center gap-2 ml-4">
                        <div
                            className={`toggle-track ${enabled ? 'active' : ''}`}
                            onClick={() => connected && onToggle(feature.name)}
                        >
                            <div className="toggle-thumb" />
                        </div>
                        <button
                            onClick={() => onRemove(feature)}
                            className="px-3 py-1.5 text-xs font-medium btn-remove text-red-400 hover:text-red-300 hover:bg-red-500/10 dark:text-red-400 dark:hover:text-red-300 rounded-lg transition-all"
                        >
                            Remove
                        </button>
                    </div>
                </div>
            );
        }

        function RemovedFeatureCard({ feature, onRecover }) {
            return (
                <div className="glass-card rounded-2xl p-4">
                    <div className="flex items-start justify-between">
                        <div className="flex-1">
                            <h3 className="text-sm font-semibold text-primary mb-1">{feature.name}</h3>
                            <p className="text-xs text-tertiary mb-2">
                                Removed {Math.floor((Date.now() - feature.removedAt) / 60000)} min ago
                            </p>
                            <div className="flex items-center gap-4 text-xs text-tertiary">
                                <span>PR #{feature.prNumber}</span>
                                <span>â€¢</span>
                                <span>{feature.lines} lines</span>
                                <span>â€¢</span>
                                <span className="text-emerald-400">Tests passing</span>
                            </div>
                        </div>
                        <button
                            onClick={() => onRecover(feature)}
                            className="px-3 py-1.5 text-xs font-medium btn-recover text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 dark:text-blue-400 dark:hover:text-blue-300 rounded-lg transition-all"
                        >
                            Restore
                        </button>
                    </div>
                </div>
            );
        }

        function EnabledFeatureCard({ feature, onReturnToStaging }) {
            return (
                <div className="glass-card rounded-2xl p-4">
                    <div className="flex items-start justify-between">
                        <div className="flex-1">
                            <h3 className="text-sm font-semibold text-primary mb-1">{feature.name}</h3>
                            <p className="text-xs text-tertiary mb-2">
                                Enabled {Math.floor((Date.now() - feature.enabledAt) / 60000)} min ago
                            </p>
                            <div className="flex items-center gap-4 text-xs text-tertiary">
                                <span>PR #{feature.prNumber}</span>
                                <span>â€¢</span>
                                <span>{feature.lines} lines</span>
                                <span>â€¢</span>
                                <span className="text-emerald-400">Tests passing</span>
                            </div>
                        </div>
                        <button
                            onClick={() => onReturnToStaging(feature)}
                            className="px-3 py-1.5 text-xs font-medium btn-recover text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 dark:text-blue-400 dark:hover:text-blue-300 rounded-lg transition-all"
                        >
                            Return to Staging
                        </button>
                    </div>
                </div>
            );
        }

        function FeatureFlagCard({ feature, onRemove }) {
            const categoryColors = {
                physics: 'text-purple-400',
                movement: 'text-purple-400',
                visual: 'text-cyan-400',
                gameplay: 'text-orange-400',
                character: 'text-pink-400'
            };

            // Count total lines across all affected files
            const totalLines = feature.filesAffected.reduce((sum, f) => sum + (f.lines || 0), 0);

            return (
                <div className="glass-card rounded-2xl p-4 flex items-center justify-between group">
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                            <h3 className="text-sm font-semibold text-primary truncate">{feature.displayName || feature.name}</h3>
                            <span className={`text-[10px] uppercase tracking-wider ${categoryColors[feature.category]} opacity-70`}>
                                {feature.category}
                            </span>
                        </div>
                        <p className="text-xs text-secondary truncate">{feature.description}</p>
                        <div className="flex items-center gap-3 mt-1 text-[10px] text-tertiary">
                            <span>{totalLines} lines</span>
                            <span>â€¢</span>
                            <span>{feature.filesAffected.length} files</span>
                            <span>â€¢</span>
                            <span className="text-emerald-400">Currently Enabled</span>
                        </div>
                    </div>
                    <div className="flex items-center gap-2 ml-4">
                        <button
                            onClick={() => onRemove(feature)}
                            className="px-3 py-1.5 text-xs font-medium text-purple-400 hover:text-purple-300 hover:bg-purple-500/10 dark:text-purple-400 dark:hover:text-purple-300 rounded-lg transition-all"
                        >
                            Replace
                        </button>
                    </div>
                </div>
            );
        }

        function RemovedFeatureFlagCard({ feature, onRecover }) {
            return (
                <div className="glass-card rounded-2xl p-4 opacity-60 hover:opacity-100 transition">
                    <div className="flex items-center justify-between">
                        <div className="flex-1">
                            <h3 className="text-sm font-semibold text-primary mb-1">{feature.displayName || feature.name}</h3>
                            <p className="text-xs text-tertiary mb-2">
                                Removed {Math.floor((Date.now() - feature.removedAt) / 60000)}m ago
                            </p>
                            <div className="flex items-center gap-3 text-xs text-tertiary">
                                <span>PR #{feature.prNumber}</span>
                                <span>â€¢</span>
                                <span>{feature.filesAffected?.length || 0} files</span>
                            </div>
                        </div>
                        <button
                            onClick={() => onRecover(feature)}
                            className="px-3 py-1.5 text-xs font-medium btn-recover text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 dark:text-blue-400 dark:hover:text-blue-300 rounded-lg transition-all"
                        >
                            Restore
                        </button>
                    </div>
                </div>
            );
        }

        function AutomationModal({ feature, type, onComplete, onCancel }) {
            const [currentStep, setCurrentStep] = useState(-1);
            const [sessionId, setSessionId] = useState(null);
            const [sessionUrl, setSessionUrl] = useState(null);
            const [subDetails, setSubDetails] = useState({});
            const [prNumber, setPrNumber] = useState(null);
            const [prUrl, setPrUrl] = useState(null);
            const [error, setError] = useState(null);
            const [useRealAPI, setUseRealAPI] = useState(false);
            const [isStopped, setIsStopped] = useState(false);
            const [pauseSuccess, setPauseSuccess] = useState(false);
            const [pauseMessage, setPauseMessage] = useState('');
            const [currentThinking, setCurrentThinking] = useState('');
            const [devinStatus, setDevinStatus] = useState('');
            const [startTime, setStartTime] = useState(null);
            const [cancelledAtStep, setCancelledAtStep] = useState(null);

            // Replacement modal state
            const [oldFlagName, setOldFlagName] = useState(feature.name || '');
            const [newFlagName, setNewFlagName] = useState('');
            const [instruction, setInstruction] = useState('');

            const steps = type === 'remove' ? removalSteps :
                         type === 'enable' ? enableSteps :
                         type === 'return-to-staging' ? returnToStagingSteps :
                         type === 'replace-flag' ? replacementSteps :
                         type === 'recover-flag' ? featureFlagRecoverySteps :
                         recoverySteps;

            useEffect(() => {
                if (currentStep === -1 || isStopped) return;

                const step = steps[currentStep];

                if (useRealAPI) {
                    // Real Devin API integration - handled in startAutomation
                    // This useEffect just manages the step progression display
                } else {
                    // Simulation mode
                    const timer = setTimeout(() => {
                        if (isStopped) return;
                        if (currentStep < steps.length - 1) {
                            setCurrentStep(currentStep + 1);
                        } else {
                            setTimeout(() => onComplete({
                                prNumber,
                                replacementInfo: type === 'replace-flag' ? { oldFlagName, newFlagName, instruction } : null
                            }), 500);
                        }
                    }, step.duration);

                    setTimeout(() => {
                        if (isStopped) return;
                        if (step.id === 'init') {
                            setSubDetails(prev => ({ ...prev, [step.id]: [`Session ID: ${sessionId}`] }));
                        } else if (step.id === 'analyze') {
                            setSubDetails(prev => ({ ...prev, [step.id]: [
                                'Found 1 feature flag definition',
                                `Located in: ${feature.file}:${feature.lineStart}-${feature.lineEnd}`
                            ]}));
                        } else if (step.id === 'backup') {
                            const backupId = `feature-backup-${feature.name.toLowerCase().replace(/\s/g, '-')}-${Date.now()}`;
                            setSubDetails(prev => ({ ...prev, [step.id]: [
                                `Backup: ${backupId}.json`,
                                `Size: ${(feature.lines * 0.08).toFixed(1)} KB (${feature.lines} lines)`
                            ]}));
                        } else if (step.id === 'test') {
                            setTimeout(() => {
                                if (!isStopped) {
                                    setSubDetails(prev => ({ ...prev, [step.id]: ['All 47 tests passing'] }));
                                }
                            }, 2500);
                        } else if (step.id === 'pr') {
                            setSubDetails(prev => ({ ...prev, [step.id]: [`PR #${prNumber}`] }));
                        }
                    }, step.duration / 3);

                    return () => clearTimeout(timer);
                }
            }, [currentStep, useRealAPI, isStopped]);

            const startAutomation = async () => {
                const configured = isDevinAPIConfigured();
                setUseRealAPI(configured);

                if (configured) {
                    // Real Devin API call with live progress tracking
                    try {
                        setStartTime(Date.now());
                        setCurrentStep(0); // Immediately show step 0 spinning

                        // After 4 seconds, advance to step 1 (step 0 gets green tick)
                        setTimeout(() => {
                            if (!isStopped) {
                                setCurrentStep(prev => Math.max(prev, 1));
                            }
                        }, 4000);

                        // Progress callback - gets called with real Devin status every 3 seconds
                        const onProgress = (status) => {
                            console.log('ðŸ“Š Devin progress update:', status);

                            // Immediately capture session URL when session is created
                            if (status.session_created && status.url) {
                                console.log('âœ“âœ“âœ“ SESSION CREATED! âœ“âœ“âœ“');
                                console.log('   Session ID:', status.session_id);
                                console.log('   Session URL:', status.url);
                                console.log('   Calling setSessionUrl()...');
                                setSessionUrl(status.url);
                                console.log('   Calling setSessionId()...');
                                setSessionId(status.session_id);
                                console.log('   âœ“ State updated - button should turn BLUE now');
                            } else if (status.session_created) {
                                console.warn('âš ï¸  Session created but no URL:', status);
                            } else if (status.url) {
                                // URL available in regular status update
                                console.log('ðŸ“Œ URL found in status update:', status.url);
                                if (!sessionUrl) {
                                    console.log('   Setting session URL from status...');
                                    setSessionUrl(status.url);
                                    setSessionId(status.session_id || sessionId);
                                }
                            }

                            // Update status badge
                            setDevinStatus(status.status_enum || status.status || 'working');

                            // Check for PR URL
                            if (status.pull_request && status.pull_request.url) {
                                setPrUrl(status.pull_request.url);
                                const prMatch = status.pull_request.url.match(/\/pull\/(\d+)/);
                                if (prMatch) {
                                    setPrNumber(parseInt(prMatch[1]));
                                }
                            }

                            // Get PR from structured_output
                            if (status.structured_output && status.structured_output.pr_number) {
                                setPrNumber(status.structured_output.pr_number);
                            }

                            // Parse Devin messages to track completion
                            const messages = status.messages || [];
                            const devinMessages = messages.filter(m => m.type === 'devin_message');
                            const messageCount = devinMessages.length;

                            console.log(`ðŸ“Š Processing ${messageCount} messages from Devin`);

                            // Show latest message (truncate before STRUCTURED OUTPUT)
                            const lastMessage = devinMessages[devinMessages.length - 1];
                            if (lastMessage) {
                                let message = lastMessage.message;
                                // Truncate before "STRUCTURED OUTPUT" or "PR: https://"
                                const structuredIndex = message.indexOf('STRUCTURED OUTPUT');
                                if (structuredIndex !== -1) {
                                    message = message.substring(0, structuredIndex).trim();
                                }
                                setCurrentThinking(message);
                            }

                            // Find which step to show as active (spinning)
                            // currentStep represents the active step, so "Step 1 complete" means advance to step 2
                            let nextActiveStep = 1; // Default: after 4s timeout, step 1 is active

                            devinMessages.forEach((message) => {
                                const fullMsg = message.message;
                                const msg = fullMsg.toLowerCase();

                                // Extract PR number from any message
                                const prMatch = fullMsg.match(/PR\s*#(\d+)/i);
                                if (prMatch) {
                                    const prNum = parseInt(prMatch[1]);
                                    setPrNumber(prNum);
                                    setPrUrl(`https://github.com/toby-drinkall/mario-feature-flags-demo-cog/pull/${prNum}`);
                                }

                                // When "Step X complete", advance to step X+1 (step X gets green, X+1 spins)
                                if (msg.includes('step 1 complete')) {
                                    nextActiveStep = Math.max(nextActiveStep, 2);
                                    console.log(`   âœ“ Step 1 complete â†’ advancing to step 2`);
                                }
                                else if (msg.includes('step 2 complete')) {
                                    nextActiveStep = Math.max(nextActiveStep, 3);
                                    console.log(`   âœ“ Step 2 complete â†’ advancing to step 3`);
                                }
                                else if (msg.includes('step 3 complete')) {
                                    nextActiveStep = Math.max(nextActiveStep, 4);
                                    console.log(`   âœ“ Step 3 complete â†’ advancing to step 4`);
                                }
                                else if (msg.includes('step 4 complete')) {
                                    nextActiveStep = Math.max(nextActiveStep, 5);
                                    console.log(`   âœ“ Step 4 complete â†’ advancing to step 5`);
                                }
                                else if (msg.includes('step 5 complete')) {
                                    nextActiveStep = Math.max(nextActiveStep, 6);
                                    console.log(`   âœ“ Step 5 complete â†’ advancing to step 6`);
                                }
                                else if (msg.includes('step 6 complete')) {
                                    nextActiveStep = Math.max(nextActiveStep, 7);
                                    console.log(`   âœ“ Step 6 complete â†’ advancing to step 7`);
                                }
                                else if (msg.includes('step 7 complete')) {
                                    nextActiveStep = Math.max(nextActiveStep, 8);
                                    console.log(`   âœ“ Step 7 complete â†’ advancing to step 8`);
                                }
                                else if (msg.includes('step 8 complete')) {
                                    nextActiveStep = Math.max(nextActiveStep, steps.length);
                                    console.log(`   âœ“ Step 8 complete â†’ all steps done!`);
                                }
                            });

                            // Update current active step based on Devin's progress
                            if (messageCount > 0) {
                                console.log(`ðŸ“ Step ${nextActiveStep} is now active (spinning)`);
                                setCurrentStep(prev => Math.max(prev, nextActiveStep));
                            }
                        };

                        if (type === 'remove') {
                            // Call real Devin API with progress tracking
                            const result = await window.DevinAPI.removeFeatureFlag(feature, onProgress);

                            // Ensure session info is set (important for Stop Automation button)
                            console.log('âœ“ Devin API result:', result);
                            console.log('   Session ID:', result.sessionId);
                            console.log('   Session URL:', result.url);
                            setSessionId(result.sessionId);
                            setSessionUrl(result.url);

                            setSubDetails({
                                init: [`Session ID: ${result.sessionId}`, `URL: ${result.url}`],
                                backup: [`Backup: ${result.backupPath}`],
                                pr: [`PR #${result.prNumber}`, `Branch: ${result.branch}`]
                            });

                            // Wait for progress callback to process all steps
                            // Only mark complete if progress callback hasn't already done so
                            setTimeout(() => {
                                setCurrentStep(prev => {
                                    if (prev < steps.length) {
                                        console.log('âš ï¸ Progress callback didn\'t reach final step, marking complete now');
                                        return steps.length;
                                    }
                                    return prev;
                                });
                            }, 2000); // Wait 2 seconds for progress callbacks to complete
                        } else if (type === 'replace-flag') {
                            // Call real Devin API to replace feature flag
                            const result = await window.DevinAPI.replaceFeatureFlag(
                                oldFlagName,
                                newFlagName,
                                instruction,
                                feature,
                                onProgress
                            );

                            console.log('âœ“ Devin API result:', result);
                            console.log('   Session ID:', result.sessionId);
                            console.log('   Session URL:', result.url);
                            console.log('   Old constant:', result.oldConstant);
                            console.log('   New constant:', result.newConstant);
                            setSessionId(result.sessionId);
                            setSessionUrl(result.url);
                            setPrNumber(result.prNumber);

                            setSubDetails({
                                init: [`Session ID: ${result.sessionId}`, `URL: ${result.url}`],
                                backup: [`Backup: ${result.backupPath}`],
                                analyze: [
                                    `Old constant: ${result.oldConstant} = ${result.oldValue}`,
                                    `New constant: ${result.newConstant}`
                                ],
                                pr: [`PR #${result.prNumber}`, `Branch: ${result.branch}`]
                            });

                            // Wait for progress callback to process all steps
                            setTimeout(() => {
                                setCurrentStep(prev => {
                                    if (prev < steps.length) {
                                        console.log('âš ï¸ Progress callback didn\'t reach final step, marking complete now');
                                        return steps.length;
                                    }
                                    return prev;
                                });
                            }, 2000);
                        } else if (type === 'recover-flag') {
                            // Call real Devin API to recover feature flag by reversing replacement
                            const replacedByName = feature.replacedBy || 'jumpmod_v2'; // Get replacement name from feature
                            const result = await window.DevinAPI.recoverFeatureFlagWithReplacement(
                                feature,
                                replacedByName,
                                feature.prNumber,
                                onProgress
                            );

                            console.log('âœ“ Devin API result:', result);
                            console.log('   Session ID:', result.sessionId);
                            console.log('   Session URL:', result.url);
                            console.log('   Removed constant:', result.removedConstant);
                            console.log('   Restored constant:', result.restoredConstant);
                            setSessionId(result.sessionId);
                            setSessionUrl(result.url);
                            setPrNumber(result.prNumber);

                            setSubDetails({
                                init: [`Session ID: ${result.sessionId}`, `URL: ${result.url}`],
                                load_backup: [`Loaded backup of ${result.restoredConstant} = ${result.restoredValue}`],
                                identify_replacement: [`Found ${result.removedConstant} in ${feature.filesAffected?.length || 0} files`],
                                pr: [`PR #${result.prNumber}`, `Branch: ${result.branch}`]
                            });

                            // Wait for progress callback to process all steps
                            setTimeout(() => {
                                setCurrentStep(prev => {
                                    if (prev < steps.length) {
                                        console.log('âš ï¸ Progress callback didn\'t reach final step, marking complete now');
                                        return steps.length;
                                    }
                                    return prev;
                                });
                            }, 2000);
                        } else {
                            // Call real Devin API to recover feature
                            const result = await window.DevinAPI.recoverFeatureFlag(feature, feature.prNumber, onProgress);

                            setSessionId(result.sessionId);
                            setSessionUrl(result.url);
                            setPrNumber(result.prNumber);
                            setSubDetails({
                                init: [`Session ID: ${result.sessionId}`, `URL: ${result.url}`],
                                pr: [`PR #${result.prNumber}`, `Branch: ${result.branch}`]
                            });

                            // Wait for progress callback to process all steps
                            // Only mark complete if progress callback hasn't already done so
                            setTimeout(() => {
                                setCurrentStep(prev => {
                                    if (prev < steps.length) {
                                        console.log('âš ï¸ Progress callback didn\'t reach final step, marking complete now');
                                        return steps.length;
                                    }
                                    return prev;
                                });
                            }, 2000); // Wait 2 seconds for progress callbacks to complete
                        }
                    } catch (err) {
                        console.error('Devin API error:', err);

                        // If user cancelled, just close modal without showing error
                        if (err.message && err.message.includes('cancelled by user')) {
                            console.log('Session cancelled - closing modal');
                            onCancel();
                            return;
                        }

                        setError(err.message || 'Failed to communicate with Devin API');
                        setCurrentStep(-1);
                    }
                } else {
                    // Simulation mode
                    setStartTime(Date.now());
                    const fakeSessionId = `dvn_${Date.now()}`;
                    setSessionId(fakeSessionId);
                    setSessionUrl(`https://app.devin.ai/sessions/${fakeSessionId}`);
                    setPrNumber(getNextPR());

                    setCurrentStep(0); // Immediately show step 0 spinning

                    // After 4 seconds, advance to step 1 (step 0 gets green tick)
                    setTimeout(() => {
                        if (!isStopped) {
                            setCurrentStep(1);
                        }
                    }, 4000);

                    console.log('ðŸ“ Simulation mode - fake session:', fakeSessionId);
                }
            };

            const isComplete = currentStep >= steps.length;
            const apiConfigured = isDevinAPIConfigured();

            // Special modal for feature flag replacement
            if (currentStep === -1 && type === 'replace-flag') {
                return (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 fade-in">
                        <div className="glass-card rounded-3xl max-w-lg w-full mx-4 p-6">
                            <h2 className="text-xl font-semibold text-primary mb-4">
                                Replace Feature Flag "{feature.displayName || feature.name}"
                            </h2>

                            {error && (
                                <div className="mb-4 p-3 rounded-xl text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30">
                                    <div className="flex items-start gap-2">
                                        <svg className="w-4 h-4 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                        <div>
                                            <div className="font-semibold mb-1">Error</div>
                                            <div>{error}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className={`mb-4 p-3 rounded-xl text-xs font-medium flex items-center gap-2 ${
                                apiConfigured
                                    ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'
                                    : 'bg-amber-500/20 text-amber-400 border border-amber-500/30'
                            }`}>
                                <div className={`w-2 h-2 rounded-full ${apiConfigured ? 'bg-emerald-400' : 'bg-amber-400'}`} />
                                {apiConfigured ? 'Real Devin API configured' : 'Running in simulation mode'}
                            </div>

                            {/* Input Fields */}
                            <div className="space-y-3 mb-4">
                                <div>
                                    <label className="block text-xs font-medium text-secondary mb-1.5">Current Feature Flag Name</label>
                                    <input
                                        type="text"
                                        value={oldFlagName}
                                        onChange={(e) => setOldFlagName(e.target.value)}
                                        className="w-full px-3 py-2 text-sm bg-white/5 border border-white/10 rounded-lg text-primary focus:outline-none focus:border-purple-500/50 transition-all"
                                        placeholder={`e.g., ${feature.name}`}
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-secondary mb-1.5">New Feature Flag Name</label>
                                    <input
                                        type="text"
                                        value={newFlagName}
                                        onChange={(e) => setNewFlagName(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Tab' && !newFlagName) {
                                                e.preventDefault();
                                                setNewFlagName(`${oldFlagName}_v2`);
                                            }
                                        }}
                                        className="w-full px-3 py-2 text-sm bg-white/5 border border-white/10 rounded-lg text-primary focus:outline-none focus:border-purple-500/50 transition-all"
                                        placeholder={`${oldFlagName}_v2 (press Tab)`}
                                    />
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-secondary mb-1.5">Instruction</label>
                                    <textarea
                                        value={instruction}
                                        onChange={(e) => setInstruction(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Tab' && !instruction) {
                                                e.preventDefault();
                                                setInstruction(`Current value: ${feature.currentValue || 'N/A'}. Note: lower value = jump higher. `);
                                            }
                                        }}
                                        rows={3}
                                        className="w-full px-3 py-2 text-sm bg-white/5 border border-white/10 rounded-lg text-primary focus:outline-none focus:border-purple-500/50 transition-all resize-none"
                                        placeholder={`Current value: ${feature.currentValue || 'N/A'}. Note: lower value = jump higher. (press Tab) Describe what changes should be made...`}
                                    />
                                </div>
                            </div>

                            {/* Summary */}
                            <div className="space-y-2 mb-6">
                                <p className="text-xs text-tertiary mb-3">Devin will execute:</p>
                                <div className="flex items-start gap-2 text-xs text-secondary">
                                    <div className="w-1 h-1 rounded-full bg-purple-400 mt-1.5" />
                                    <div>Rename <span className="text-purple-400">{oldFlagName || 'feature flag'}</span> â†’ <span className="text-purple-400">{newFlagName || 'new name'}</span></div>
                                </div>
                                <div className="flex items-start gap-2 text-xs text-secondary">
                                    <div className="w-1 h-1 rounded-full bg-purple-400 mt-1.5" />
                                    <div>Update implementation: {instruction || 'as described'}</div>
                                </div>
                                <div className="flex items-start gap-2 text-xs text-secondary">
                                    <div className="w-1 h-1 rounded-full bg-purple-400 mt-1.5" />
                                    <div>Run tests and create atomic PR</div>
                                </div>
                            </div>

                            <div className="flex gap-3">
                                <button
                                    onClick={onCancel}
                                    className="flex-1 px-4 py-2.5 text-sm font-medium text-secondary hover:text-primary bg-white/5 hover:bg-white/10 dark:bg-white/5 dark:hover:bg-white/10 light:bg-slate-100 light:hover:bg-slate-200 rounded-xl transition-all border border-white/10 dark:border-white/10 light:border-slate-300"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={startAutomation}
                                    disabled={!oldFlagName || !newFlagName || !instruction}
                                    className="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-xl transition-all shadow-lg"
                                >
                                    Start Replacement
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentStep === -1) {
                return (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 fade-in">
                        <div className="glass-card rounded-3xl max-w-md w-full mx-4 p-6">
                            <h2 className="text-xl font-semibold text-primary mb-4">
                                {type === 'remove' ? 'Remove' :
                                 type === 'enable' ? 'Enable' :
                                 type === 'return-to-staging' ? 'Return to Staging' :
                                 type === 'recover-flag' ? 'Recover' :
                                 'Recover'} "{feature.name}"?
                            </h2>

                            {error && (
                                <div className="mb-4 p-3 rounded-xl text-xs font-medium bg-red-500/20 text-red-400 border border-red-500/30">
                                    <div className="flex items-start gap-2">
                                        <svg className="w-4 h-4 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                        <div>
                                            <div className="font-semibold mb-1">Error</div>
                                            <div>{error}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className={`mb-4 p-3 rounded-xl text-xs font-medium flex items-center gap-2 ${
                                apiConfigured
                                    ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'
                                    : 'bg-amber-500/20 text-amber-400 border border-amber-500/30'
                            }`}>
                                <div className={`w-2 h-2 rounded-full ${apiConfigured ? 'bg-emerald-400' : 'bg-amber-400'}`} />
                                {apiConfigured ? 'Real Devin API configured' : 'Running in simulation mode'}
                            </div>

                            <div className="space-y-2 mb-6">
                                <p className="text-xs text-tertiary mb-3">Devin will execute:</p>
                                {steps.slice(0, 6).map(step => (
                                    <div key={step.id} className="flex items-center gap-2 text-xs text-secondary">
                                        <div className="w-1 h-1 rounded-full bg-blue-400" />
                                        {step.label}
                                    </div>
                                ))}
                            </div>

                            <div className="flex gap-3">
                                <button
                                    onClick={onCancel}
                                    className="flex-1 px-4 py-2.5 text-sm font-medium text-secondary hover:text-primary bg-white/5 hover:bg-white/10 dark:bg-white/5 dark:hover:bg-white/10 light:bg-slate-100 light:hover:bg-slate-200 rounded-xl transition-all border border-white/10 dark:border-white/10 light:border-slate-300"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={startAutomation}
                                    className="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-xl transition-all shadow-lg"
                                >
                                    Start Automation
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }


            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
                    <div className="glass-card rounded-3xl max-w-2xl w-full mx-4 p-6 max-h-[80vh] overflow-y-auto relative">
                        {/* Close X button - top left */}
                        <button
                            onClick={() => {
                                // If complete AND not stopped early, call onComplete to move feature
                                // If stopped or cancelled, just close modal without moving feature
                                if (isComplete && !pauseSuccess) {
                                    onComplete({
                                        prNumber,
                                        replacementInfo: type === 'replace-flag' ? { oldFlagName, newFlagName, instruction } : null
                                    });
                                } else {
                                    onCancel();
                                }
                            }}
                            className="absolute top-4 left-4 w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 transition-all border border-red-500/30 hover:border-red-500/50 z-10"
                            title="Close modal"
                        >
                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                            </svg>
                        </button>

                        <div className="flex items-start justify-between mb-4 pl-12">
                            <div className="flex-1">
                                <h2 className="text-xl font-semibold text-primary mb-1">
                                    Devin is {type === 'remove' ? 'removing' :
                                             type === 'enable' ? 'enabling' :
                                             type === 'return-to-staging' ? 'returning' :
                                             type === 'recover-flag' ? 'recovering' :
                                             'recovering'} "{feature.name}"
                                </h2>
                                {prNumber && (
                                    <div className="flex items-center gap-2 mt-2">
                                        <a
                                            href={prUrl || `https://github.com/toby-drinkall/mario-feature-flags-demo-cog/pull/${prNumber}`}
                                            target="_blank"
                                            className="text-xs px-2 py-1 rounded bg-purple-500/20 text-purple-400 hover:bg-purple-500/30 transition flex items-center gap-1"
                                        >
                                            <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                                            </svg>
                                            PR #{prNumber}
                                        </a>
                                    </div>
                                )}
                            </div>
                            {!isComplete && !pauseSuccess && (
                                <div className="w-10 h-10 border-2 border-blue-500 border-t-transparent rounded-full spinner ml-4" />
                            )}
                        </div>

                        {/* Current thinking display */}
                        {currentThinking && !pauseSuccess && (
                            <div className="mb-4 p-3 rounded-xl bg-blue-500/10 border border-blue-500/20">
                                <p className="text-xs text-blue-400 font-medium mb-1">Devin's current thinking:</p>
                                <p className="text-sm text-secondary">{currentThinking}</p>
                            </div>
                        )}

                        {/* Pause feedback message */}
                        {pauseMessage && (
                            <div className={`mb-4 p-3 rounded-xl border ${
                                pauseSuccess
                                    ? 'bg-amber-500/10 border-amber-500/30'
                                    : 'bg-red-500/10 border-red-500/30'
                            }`}>
                                <div className="flex items-start gap-2">
                                    <svg className={`w-5 h-5 flex-shrink-0 ${pauseSuccess ? 'text-amber-400' : 'text-red-400'}`} fill="currentColor" viewBox="0 0 20 20">
                                        {pauseSuccess ? (
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clipRule="evenodd" />
                                        ) : (
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        )}
                                    </svg>
                                    <div className="flex-1">
                                        <p className={`text-sm font-medium ${pauseSuccess ? 'text-amber-400' : 'text-red-400'}`}>
                                            {pauseSuccess ? 'Session Cancelled' : 'Stop Failed'}
                                        </p>
                                        <p className="text-xs text-secondary mt-1">{pauseMessage}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="space-y-3 mb-6">
                            {steps.map((step, idx) => {
                                // currentStep represents the currently active (spinning) step
                                // All steps before currentStep are complete (green tick)
                                // If cancelled, show red X for steps after cancelledAtStep
                                let status;
                                if (cancelledAtStep !== null && idx > cancelledAtStep) {
                                    status = 'cancelled';
                                } else if (idx < currentStep) {
                                    status = 'complete';
                                } else if (idx === currentStep) {
                                    status = cancelledAtStep !== null ? 'cancelled' : 'active';
                                } else {
                                    status = 'waiting';
                                }

                                return (
                                    <div key={step.id} className="fade-in">
                                        <div className="flex items-start gap-3">
                                            <div className="flex-shrink-0 mt-1">
                                                {status === 'complete' && (
                                                    <div className="w-5 h-5 bg-emerald-500 rounded-full flex items-center justify-center">
                                                        <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                        </svg>
                                                    </div>
                                                )}
                                                {status === 'active' && (
                                                    <div className="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full spinner" />
                                                )}
                                                {status === 'cancelled' && (
                                                    <div className="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                                                        <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                                        </svg>
                                                    </div>
                                                )}
                                                {status === 'waiting' && (
                                                    <div className="w-5 h-5 bg-white/10 rounded-full" />
                                                )}
                                            </div>
                                            <div className="flex-1">
                                                <p className={`text-sm font-medium ${
                                                    status === 'active' ? 'text-blue-400' :
                                                    status === 'complete' ? 'text-secondary' :
                                                    'text-tertiary'
                                                }`}>
                                                    {step.label}
                                                </p>
                                                {subDetails[step.id] && (
                                                    <div className="mt-1 ml-3 space-y-0.5">
                                                        {subDetails[step.id].map((detail, i) => (
                                                            <p key={i} className="text-xs text-tertiary">â””â”€ {detail}</p>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="flex gap-3">
                            {/* Left: View in Devin Session (blue button) */}
                            <a
                                href="https://app.devin.ai/"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="flex-1 px-4 py-2.5 text-sm font-medium rounded-xl transition-all flex items-center justify-center gap-2 border text-blue-400 hover:text-blue-300 bg-blue-500/10 hover:bg-blue-500/20 border-blue-500/30 hover:border-blue-500/50 cursor-pointer"
                            >
                                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                                    <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                                </svg>
                                View in Devin Session
                            </a>

                            {/* Right: Stop Automation / Automation Complete */}
                            <button
                                onClick={async () => {
                                    // If complete, close modal
                                    if (isComplete) {
                                        onComplete({
                                            prNumber,
                                            replacementInfo: type === 'replace-flag' ? { oldFlagName, newFlagName, instruction } : null
                                        });
                                        return;
                                    }

                                    // If already paused, do nothing
                                    if (pauseSuccess) {
                                        return;
                                    }

                                    // Otherwise, terminate the automation
                                    setIsStopped(true);
                                    setPauseMessage('');
                                    setPauseSuccess(false);

                                    // Capture which step we were on when cancelled
                                    setCancelledAtStep(currentStep);

                                    // Terminate the Devin session if we have a session ID
                                    if (sessionId && window.DevinAPI) {
                                        try {
                                            console.log('ðŸ›‘ Terminating Devin session...');
                                            await window.DevinAPI.cancelSession(sessionId);

                                            console.log('âœ“ Devin session terminated successfully');
                                            setPauseSuccess(true);
                                            setPauseMessage('Session cancelled. The feature remains in Testing Game Modes.');
                                            setDevinStatus('cancelled');

                                            // Update current thinking to show cancellation
                                            setCurrentThinking('Session cancelled by user.');
                                        } catch (err) {
                                            console.error('âŒ Failed to terminate Devin session:', err);
                                            setPauseMessage(`Failed to stop automation: ${err.message}`);
                                            setIsStopped(false);
                                        }
                                    } else {
                                        setPauseMessage('No session ID available to terminate.');
                                        setIsStopped(false);
                                    }
                                }}
                                disabled={isStopped || pauseSuccess}
                                className={`flex-1 px-4 py-2.5 text-sm font-medium rounded-xl transition-all flex items-center justify-center gap-2 ${
                                    isComplete
                                        ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 hover:bg-emerald-500/30 hover:border-emerald-500/50 cursor-pointer'
                                        : pauseSuccess
                                        ? 'bg-red-500/20 text-red-400 border border-red-500/30 cursor-default'
                                        : isStopped
                                        ? 'bg-gray-500/20 text-gray-400 cursor-wait border border-gray-500/30'
                                        : 'bg-red-500/20 text-red-400 hover:bg-red-500/30 hover:text-red-300 border border-red-500/30 hover:border-red-500/50'
                                }`}
                            >
                                {isComplete ? (
                                    <>
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                                        </svg>
                                        View Dashboard
                                    </>
                                ) : pauseSuccess ? (
                                    <>
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" />
                                        </svg>
                                        Automation Cancelled
                                    </>
                                ) : isStopped ? (
                                    <>
                                        <div className="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full spinner" />
                                        Stopping...
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clipRule="evenodd" />
                                        </svg>
                                        Stop Automation
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function Dashboard() {
            const [isDark, setIsDark] = useTheme();
            const [gameWindow, setGameWindow] = useState(null);
            const [connected, setConnected] = useState(false);
            const [modStates, setModStates] = useState({});
            const [removedFeatures, setRemovedFeatures] = useState(() => {
                const stored = localStorage.getItem('removed_features');
                return stored ? JSON.parse(stored) : [];
            });
            const [enabledFeatures, setEnabledFeatures] = useState(() => {
                const stored = localStorage.getItem('enabled_features');
                return stored ? JSON.parse(stored) : [];
            });
            const [pendingRemoval, setPendingRemoval] = useState(() => {
                const stored = localStorage.getItem('pending_removal');
                return stored ? JSON.parse(stored) : [];
            });
            const [pendingRestoration, setPendingRestoration] = useState(() => {
                const stored = localStorage.getItem('pending_restoration');
                return stored ? JSON.parse(stored) : [];
            });
            const [activeModal, setActiveModal] = useState(null);
            const [activeTab, setActiveTab] = useState('testing'); // 'testing' or 'flags'
            const [checkingMerge, setCheckingMerge] = useState(null); // Track which feature is being checked
            const [mergeSuccess, setMergeSuccess] = useState(null); // Track merge completion
            const [removedFeatureFlags, setRemovedFeatureFlags] = useState(() => {
                const stored = localStorage.getItem('removed_feature_flags');
                return stored ? JSON.parse(stored) : [];
            });
            const [newFeatureFlags, setNewFeatureFlags] = useState(() => {
                const stored = localStorage.getItem('new_feature_flags');
                return stored ? JSON.parse(stored) : [];
            });
            const [isSyncing, setIsSyncing] = useState(false);
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const [manualCheckInProgress, setManualCheckInProgress] = useState(false);

            // GitHub Sync System - Parse PR titles and sync state
            const syncWithGitHub = async () => {
                if (isSyncing || manualCheckInProgress) {
                    console.log('â¸ï¸ Sync already in progress, skipping...');
                    return;
                }

                console.log('ðŸ”„ Starting GitHub sync...');
                setIsSyncing(true);

                try {
                    // Fetch all PRs from GitHub
                    const response = await fetch('https://api.github.com/repos/toby-drinkall/mario-feature-flags-demo-cog/pulls?state=all&per_page=50');
                    if (!response.ok) {
                        console.error('Failed to fetch PRs from GitHub');
                        setIsSyncing(false);
                        return;
                    }

                    const prs = await response.json();
                    console.log(`ðŸ“¦ Fetched ${prs.length} PRs from GitHub`);

                    // Parse PRs and build state
                    // We need to process PRs in chronological order to track state transitions
                    const newPendingRemoval = [];
                    const newPendingRestoration = [];
                    const newRemovedFeatures = [];
                    const newRemovedFeatureFlags = [];
                    const newlyCreatedFlags = []; // Track new flags created from replacements

                    // Track feature states by processing PRs chronologically
                    const featureStates = new Map(); // featureName -> { state, pr, feature }

                    // Sort PRs by merged/created date (oldest first) to process chronologically
                    prs.sort((a, b) => {
                        const dateA = new Date(a.merged_at || a.created_at);
                        const dateB = new Date(b.merged_at || b.created_at);
                        return dateA - dateB;
                    });

                    prs.forEach(pr => {
                        const title = pr.title;
                        const prNumber = pr.number;
                        const isOpen = pr.state === 'open';
                        const isMerged = pr.merged_at !== null;

                        // Parse title to extract action and feature name
                        let action = null;
                        let featureName = null;
                        let newFeatureName = null;
                        let isFeatureFlag = false;

                        if (title.match(/^Remove (.+) feature flag$/i)) {
                            action = 'remove';
                            featureName = title.match(/^Remove (.+) feature flag$/i)[1];
                            // Check if this is an actual feature flag or a game mode
                            isFeatureFlag = featureFlagsData.some(f => f.displayName === featureName || f.name === featureName);
                        } else if (title.match(/^Recover (.+) feature flag$/i)) {
                            action = 'recover';
                            featureName = title.match(/^Recover (.+) feature flag$/i)[1];
                            isFeatureFlag = featureFlagsData.some(f => f.displayName === featureName || f.name === featureName);
                        } else if (title.match(/^Replace (.+) with (.+)$/i)) {
                            action = 'replace';
                            const match = title.match(/^Replace (.+) with (.+)$/i);
                            featureName = match[1];
                            newFeatureName = match[2];
                            isFeatureFlag = featureFlagsData.some(f => f.displayName === featureName || f.name === featureName);
                        }

                        if (!action || !featureName) return;

                        // Find matching feature in modsData or featureFlagsData
                        const feature = isFeatureFlag
                            ? featureFlagsData.find(f => f.displayName === featureName || f.name === featureName)
                            : modsData.find(m => m.name === featureName);

                        if (!feature) {
                            console.warn(`Feature "${featureName}" not found in ${isFeatureFlag ? 'featureFlagsData' : 'modsData'}`);
                            return;
                        }

                        console.log(`  PR #${prNumber}: ${action} "${featureName}" - ${isOpen ? 'OPEN' : isMerged ? 'MERGED' : 'CLOSED'}`);

                        // Track state transitions
                        const currentState = featureStates.get(featureName);

                        if (action === 'remove') {
                            if (isOpen && !isMerged) {
                                // Open removal PR - mark as pending removal
                                featureStates.set(featureName, {
                                    state: 'pending_removal',
                                    pr,
                                    feature,
                                    prNumber,
                                    prUrl: pr.html_url,
                                    createdAt: new Date(pr.created_at).getTime(),
                                    backupId: `feature-backup-${featureName.toLowerCase().replace(/\s/g, '-')}-${new Date(pr.created_at).getTime()}.json`
                                });
                            } else if (isMerged) {
                                // Merged removal PR - mark as removed
                                featureStates.set(featureName, {
                                    state: 'removed',
                                    pr,
                                    feature,
                                    prNumber,
                                    prUrl: pr.html_url,
                                    removedAt: new Date(pr.merged_at).getTime(),
                                    backupId: `feature-backup-${featureName.toLowerCase().replace(/\s/g, '-')}-${new Date(pr.created_at).getTime()}.json`
                                });
                            }
                        } else if (action === 'recover') {
                            if (isOpen && !isMerged) {
                                // Open recovery PR - mark as pending restoration
                                // Only makes sense if feature is currently removed
                                if (currentState && currentState.state === 'removed') {
                                    featureStates.set(featureName, {
                                        state: 'pending_restoration',
                                        pr,
                                        feature,
                                        prNumber,
                                        prUrl: pr.html_url,
                                        createdAt: new Date(pr.created_at).getTime(),
                                        // Keep the original removal info
                                        originalRemovalPR: currentState.prNumber,
                                        removedAt: currentState.removedAt,
                                        backupId: currentState.backupId,
                                        replacedBy: currentState.replacedBy // Track what it was replaced by
                                    });

                                    // If this feature was replaced, mark the replacement for removal too
                                    if (currentState.replacedBy) {
                                        const replacementName = currentState.replacedBy;
                                        featureStates.set(replacementName, {
                                            state: 'pending_removal_by_recovery',
                                            pr,
                                            prNumber,
                                            prUrl: pr.html_url,
                                            createdAt: new Date(pr.created_at).getTime(),
                                            replacementFor: featureName
                                        });
                                    }
                                }
                            } else if (isMerged) {
                                // Merged recovery PR - feature is restored (back to active)
                                featureStates.delete(featureName); // Remove from tracking = back to active

                                // If this feature was replaced, also remove the replacement from tracking
                                if (currentState && currentState.replacedBy) {
                                    featureStates.delete(currentState.replacedBy);
                                }
                            }
                        } else if (action === 'replace') {
                            if (isOpen && !isMerged) {
                                // Open replacement PR - old flag pending removal, new flag will be created
                                featureStates.set(featureName, {
                                    state: 'pending_replacement',
                                    pr,
                                    feature,
                                    prNumber,
                                    prUrl: pr.html_url,
                                    createdAt: new Date(pr.created_at).getTime(),
                                    backupId: `feature-backup-${featureName.toLowerCase().replace(/\s/g, '-')}-${new Date(pr.created_at).getTime()}.json`,
                                    newFeatureName: newFeatureName
                                });
                            } else if (isMerged) {
                                // Merged replacement PR - old flag is removed
                                featureStates.set(featureName, {
                                    state: 'removed',
                                    pr,
                                    feature,
                                    prNumber,
                                    prUrl: pr.html_url,
                                    removedAt: new Date(pr.merged_at).getTime(),
                                    backupId: `feature-backup-${featureName.toLowerCase().replace(/\s/g, '-')}-${new Date(pr.created_at).getTime()}.json`,
                                    replacedBy: newFeatureName
                                });
                                // New flag is now active - track it (if not already tracked)
                                if (!newlyCreatedFlags.some(f => f.name === newFeatureName)) {
                                    newlyCreatedFlags.push({
                                        name: newFeatureName,
                                        displayName: newFeatureName,
                                        description: `Replaced ${featureName}`,
                                        file: feature.file,
                                        lineStart: feature.lineStart,
                                        lineEnd: feature.lineEnd,
                                        lines: feature.lines,
                                        category: feature.category,
                                        filesAffected: feature.filesAffected || [],
                                        enabled: true,
                                        currentValue: 'calculated',
                                        createdAt: new Date(pr.merged_at).getTime(),
                                        prNumber: prNumber,
                                        prUrl: pr.html_url,
                                        replacedFrom: featureName
                                    });
                                }
                            }
                        }
                    });

                    // Convert featureStates map to arrays for state
                    featureStates.forEach((data, featureName) => {
                        const isFlag = featureFlagsData.some(f => f.displayName === featureName || f.name === featureName || f.name === data.feature?.name);

                        if (data.state === 'pending_removal' || data.state === 'pending_replacement') {
                            newPendingRemoval.push({
                                ...data.feature,
                                prNumber: data.prNumber,
                                prUrl: data.prUrl,
                                createdAt: data.createdAt,
                                backupId: data.backupId,
                                replacementInfo: data.newFeatureName ? {
                                    newFeatureName: data.newFeatureName
                                } : undefined
                            });
                        } else if (data.state === 'pending_removal_by_recovery') {
                            // Replacement flag being removed by recovery PR
                            // Don't add to any section - it will be completely deleted when recovery PR merges
                            // Just track the name so we can filter it out from active flags
                            console.log(`ðŸ”„ Recovery PR #${data.prNumber}: Marking ${featureName} for deletion (replacement of ${data.replacementFor})`);
                        } else if (data.state === 'pending_restoration') {
                            newPendingRestoration.push({
                                ...data.feature,
                                prNumber: data.prNumber,
                                prUrl: data.prUrl,
                                createdAt: data.createdAt,
                                removedAt: data.removedAt,
                                backupId: data.backupId,
                                replacedBy: data.replacedBy // Include what it was replaced by
                            });
                        } else if (data.state === 'removed') {
                            // Separate feature flags from game modes
                            if (isFlag) {
                                newRemovedFeatureFlags.push({
                                    ...data.feature,
                                    prNumber: data.prNumber,
                                    prUrl: data.prUrl,
                                    removedAt: data.removedAt,
                                    backupId: data.backupId
                                });
                            } else {
                                newRemovedFeatures.push({
                                    ...data.feature,
                                    prNumber: data.prNumber,
                                    prUrl: data.prUrl,
                                    removedAt: data.removedAt,
                                    backupId: data.backupId
                                });
                            }
                        }
                    });

                    // Update state
                    console.log(`âœ… Sync complete:`);
                    console.log(`   - Pending removal: ${newPendingRemoval.length}`);
                    console.log(`   - Pending restoration: ${newPendingRestoration.length}`);
                    console.log(`   - Removed game modes: ${newRemovedFeatures.length}`);
                    console.log(`   - Removed feature flags: ${newRemovedFeatureFlags.length}`);
                    console.log(`   - New feature flags: ${newlyCreatedFlags.length}`);

                    setPendingRemoval(newPendingRemoval);
                    setPendingRestoration(newPendingRestoration);
                    setRemovedFeatures(newRemovedFeatures);
                    setRemovedFeatureFlags(newRemovedFeatureFlags);

                    // Collect flags marked for removal by recovery PRs
                    const flagsMarkedForDeletion = [];
                    featureStates.forEach((data, featureName) => {
                        if (data.state === 'pending_removal_by_recovery') {
                            flagsMarkedForDeletion.push(featureName);
                        }
                    });

                    // Also mark flags for deletion if their original was restored
                    // (handles case where recovery PR merged to wrong branch and GitHub sync missed it)
                    featureStates.forEach((data, featureName) => {
                        if (data.state === 'removed' && data.replacedBy) {
                            // This flag was replaced, check if there's an active restoration
                            featureStates.forEach((restoreData, restoreFeatureName) => {
                                if (restoreFeatureName === featureName && restoreData.state === undefined) {
                                    // Original is back - mark replacement for deletion
                                    if (!flagsMarkedForDeletion.includes(data.replacedBy)) {
                                        console.log(`ðŸ”„ ${featureName} is back - marking ${data.replacedBy} for deletion`);
                                        flagsMarkedForDeletion.push(data.replacedBy);
                                    }
                                }
                            });
                        }
                    });

                    // Additionally, if a hardcoded flag is active, remove any dynamic versions with the same base name
                    featureFlagsData.forEach(hardcodedFlag => {
                        const baseName = hardcodedFlag.name;
                        // Check if this hardcoded flag should be active (not removed, not pending)
                        const shouldBeActive = !featureStates.has(baseName) ||
                                              (featureStates.get(baseName)?.state !== 'removed' &&
                                               featureStates.get(baseName)?.state !== 'pending_removal');

                        if (shouldBeActive) {
                            // Remove any v2/v3/etc versions from newFeatureFlags
                            newlyCreatedFlags.forEach(newFlag => {
                                if (newFlag.name.startsWith(baseName + '_v') || newFlag.replacedFrom === baseName) {
                                    if (!flagsMarkedForDeletion.includes(newFlag.name)) {
                                        console.log(`ðŸ”„ ${baseName} is active - removing replacement ${newFlag.name}`);
                                        flagsMarkedForDeletion.push(newFlag.name);
                                    }
                                }
                            });
                        }
                    });

                    // Merge with existing new flags and deduplicate by name
                    const allNewFlags = [...newFeatureFlags, ...newlyCreatedFlags];
                    const uniqueNewFlags = allNewFlags
                        .filter((flag, index, self) =>
                            index === self.findIndex(f => f.name === flag.name)
                        )
                        .filter(flag => !flagsMarkedForDeletion.includes(flag.name)); // Remove flags marked for deletion

                    if (flagsMarkedForDeletion.length > 0) {
                        console.log(`   - Flags marked for deletion: ${flagsMarkedForDeletion.join(', ')}`);
                    }

                    setNewFeatureFlags(uniqueNewFlags);

                    // Update localStorage
                    localStorage.setItem('pending_removal', JSON.stringify(newPendingRemoval));
                    localStorage.setItem('pending_restoration', JSON.stringify(newPendingRestoration));
                    localStorage.setItem('removed_features', JSON.stringify(newRemovedFeatures));
                    localStorage.setItem('removed_feature_flags', JSON.stringify(newRemovedFeatureFlags));
                    localStorage.setItem('new_feature_flags', JSON.stringify(uniqueNewFlags));

                    setLastSyncTime(Date.now());
                    console.log('âœ… GitHub sync complete!');
                } catch (err) {
                    console.error('âŒ Error syncing with GitHub:', err);
                    alert(`Failed to sync with GitHub: ${err.message}`);
                } finally {
                    // Add a small delay so user can see the "Syncing..." state
                    setTimeout(() => {
                        setIsSyncing(false);
                    }, 500);
                }
            };

            // Auto-sync on page load to fix any stale localStorage state
            useEffect(() => {
                console.log('ðŸ”„ Dashboard mounted - auto-syncing with GitHub to ensure clean state...');
                syncWithGitHub();
            }, []); // Run once on mount

            useEffect(() => {
                const interval = setInterval(() => {
                    try {
                        if (!gameWindow || gameWindow.closed) {
                            setConnected(false);
                            return;
                        }

                        // Check if we can access the game window
                        const hasFSM = !!gameWindow.FSM;
                        const hasModAttacher = hasFSM && !!gameWindow.FSM.ModAttacher;
                        const isConnected = hasModAttacher;

                        console.log('Connection check:', {
                            windowExists: !!gameWindow,
                            windowClosed: gameWindow.closed,
                            hasFSM,
                            hasModAttacher,
                            isConnected
                        });

                        setConnected(isConnected);
                        if (isConnected) updateModStates(gameWindow);
                    } catch (e) {
                        console.error('Connection check error:', e.message);
                        setConnected(false);
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, [gameWindow]);

            const openGame = () => {
                console.log('Opening game window...');
                const win = window.open('index.html', 'Mario Bros. for Cognition', 'width=1200,height=800');

                if (!win) {
                    console.error('Failed to open game window - popup may be blocked');
                    return;
                }

                console.log('Game window opened, waiting for FSM to load...');
                setGameWindow(win);

                const checkLoaded = setInterval(() => {
                    try {
                        if (win.FSM && win.FSM.ModAttacher) {
                            console.log('âœ“ Game loaded successfully, FSM.ModAttacher is available');
                            clearInterval(checkLoaded);
                            updateModStates(win);
                        } else {
                            console.log('Still waiting for FSM...', { hasFSM: !!win.FSM, hasModAttacher: !!(win.FSM && win.FSM.ModAttacher) });
                        }
                    } catch (e) {
                        console.error('Error checking game load status:', e.message);
                    }
                }, 100);
            };

            const updateModStates = (win) => {
                if (!win || !win.FSM) return;
                const states = {};
                modsData.filter(m => !removedFeatures.find(r => r.name === m.name)).forEach(mod => {
                    try {
                        const modData = win.FSM.ModAttacher.getMod(mod.name);
                        states[mod.name] = modData ? modData.enabled : false;
                    } catch (e) {
                        states[mod.name] = false;
                    }
                });
                setModStates(states);
            };

            const toggleMod = (modName) => {
                if (!connected) return;
                try {
                    gameWindow.FSM.ModAttacher.toggleMod(modName);
                    const newState = gameWindow.FSM.ModAttacher.getMod(modName).enabled;
                    setModStates(prev => ({ ...prev, [modName]: newState }));
                } catch (err) {
                    console.error('Error toggling mod:', err);
                }
            };

            const handleRemoveComplete = (feature, prNumber) => {
                // Put in "pending removal" state - waiting for PR merge
                const pending = {
                    ...feature,
                    createdAt: Date.now(),
                    prNumber,
                    prUrl: `https://github.com/toby-drinkall/mario-feature-flags-demo-cog/pull/${prNumber}`,
                    backupId: `feature-backup-${feature.name.toLowerCase().replace(/\s/g, '-')}-${Date.now()}.json`
                };
                const newPending = [...pendingRemoval, pending];
                setPendingRemoval(newPending);
                localStorage.setItem('pending_removal', JSON.stringify(newPending));

                setActiveModal(null);

                console.log(`âœ“ PR #${prNumber} created. Waiting for merge to complete removal.`);
            };

            const handleRecoverComplete = (feature, prNumber) => {
                // Put in "pending restoration" state - waiting for PR merge
                const pending = {
                    ...feature,
                    createdAt: Date.now(),
                    prNumber,
                    prUrl: `https://github.com/toby-drinkall/mario-feature-flags-demo-cog/pull/${prNumber}`,
                };
                const newPending = [...pendingRestoration, pending];
                setPendingRestoration(newPending);
                localStorage.setItem('pending_restoration', JSON.stringify(newPending));

                setActiveModal(null);

                console.log(`âœ“ PR #${prNumber} created. Waiting for merge to complete restoration.`);
            };

            const handleEnableComplete = (feature, prNumber) => {
                const enabled = {
                    ...feature,
                    enabledAt: Date.now(),
                    prNumber,
                    backupId: `feature-backup-${feature.name.toLowerCase().replace(/\s/g, '-')}-${Date.now()}.json`
                };
                const newEnabled = [...enabledFeatures, enabled];
                setEnabledFeatures(newEnabled);
                localStorage.setItem('enabled_features', JSON.stringify(newEnabled));
                setActiveModal(null);
            };

            const handleReturnToStagingComplete = (feature, prNumber) => {
                const newEnabled = enabledFeatures.filter(e => e.name !== feature.name);
                setEnabledFeatures(newEnabled);
                localStorage.setItem('enabled_features', JSON.stringify(newEnabled));
                setActiveModal(null);
            };

            const handleReplaceComplete = (feature, prNumber, oldFlagName, newFlagName, instruction) => {
                // Put in "pending removal" state for tracking - the old flag will be removed
                const pending = {
                    ...feature,
                    createdAt: Date.now(),
                    prNumber,
                    prUrl: `https://github.com/toby-drinkall/mario-feature-flags-demo-cog/pull/${prNumber}`,
                    backupId: `feature-backup-${feature.name.toLowerCase().replace(/\s/g, '-')}-${Date.now()}.json`,
                    replacementInfo: {
                        oldFlagName,
                        newFlagName,
                        instruction
                    }
                };
                const newPending = [...pendingRemoval, pending];
                setPendingRemoval(newPending);
                localStorage.setItem('pending_removal', JSON.stringify(newPending));

                setActiveModal(null);

                console.log(`âœ“ PR #${prNumber} created for replacement: ${oldFlagName} â†’ ${newFlagName}`);
                console.log(`   Instruction: ${instruction}`);
                console.log(`   Waiting for merge to complete replacement.`);

                // Auto-sync to update dashboard immediately
                setTimeout(() => syncWithGitHub(), 1000);
            };

            const handleRecoverFlagComplete = (feature, prNumber) => {
                // Put in "pending restoration" state - waiting for PR merge
                const pending = {
                    ...feature,
                    createdAt: Date.now(),
                    prNumber,
                    prUrl: `https://github.com/toby-drinkall/mario-feature-flags-demo-cog/pull/${prNumber}`,
                };
                const newPending = [...pendingRestoration, pending];
                setPendingRestoration(newPending);
                localStorage.setItem('pending_restoration', JSON.stringify(newPending));

                setActiveModal(null);

                console.log(`âœ“ PR #${prNumber} created for feature flag recovery: ${feature.name}`);
                console.log(`   ${feature.replacedBy} will be completely removed (not tracked)`);
                console.log(`   ${feature.name} = ${feature.currentValue} will be restored`);
                console.log(`   Waiting for merge to complete recovery.`);
            };

            // Check if a GitHub PR is merged
            const checkPRMerged = async (prNumber) => {
                try {
                    console.log(`ðŸ” Checking PR #${prNumber} on GitHub...`);
                    const response = await fetch(`https://api.github.com/repos/toby-drinkall/mario-feature-flags-demo-cog/pulls/${prNumber}`);
                    if (!response.ok) {
                        console.error(`âŒ Failed to check PR status: ${response.status} ${response.statusText}`);
                        return false;
                    }
                    const pr = await response.json();
                    console.log(`   PR #${prNumber} details:`, {
                        title: pr.title,
                        state: pr.state,
                        merged: pr.merged,
                        merged_at: pr.merged_at
                    });
                    return pr.merged === true;
                } catch (err) {
                    console.error('âŒ Error checking PR merge status:', err);
                    return false;
                }
            };

            // Complete the removal after PR is merged
            const completeRemoval = (feature) => {
                // Remove from pending
                const newPending = pendingRemoval.filter(p => p.name !== feature.name);
                setPendingRemoval(newPending);
                localStorage.setItem('pending_removal', JSON.stringify(newPending));

                // Check if this is a feature flag or game mode
                const isFeatureFlag = featureFlagsData.some(f => f.displayName === feature.name || f.name === feature.name) ||
                                     newFeatureFlags.some(f => f.displayName === feature.name || f.name === feature.name);

                // Add to removed
                const removed = {
                    ...feature,
                    removedAt: Date.now(),
                };

                if (isFeatureFlag) {
                    // Add to removed feature flags
                    const newRemovedFlags = [...removedFeatureFlags, removed];
                    setRemovedFeatureFlags(newRemovedFlags);
                    localStorage.setItem('removed_feature_flags', JSON.stringify(newRemovedFlags));
                    console.log(`âœ… PR #${feature.prNumber} merged. Feature flag ${feature.name} removed.`);
                } else {
                    // Add to removed game modes
                    const newRemoved = [...removedFeatures, removed];
                    setRemovedFeatures(newRemoved);
                    localStorage.setItem('removed_features', JSON.stringify(newRemoved));

                    // Disable in game
                    if (connected && gameWindow && gameWindow.FSM && gameWindow.FSM.ModAttacher) {
                        try {
                            const modData = gameWindow.FSM.ModAttacher.getMod(feature.name);
                            if (modData && modData.enabled) {
                                console.log(`Disabling ${feature.name} in game after PR merge`);
                                gameWindow.FSM.ModAttacher.toggleMod(feature.name);
                            }
                            updateModStates(gameWindow);
                        } catch (err) {
                            console.error('Error disabling mod in game:', err);
                        }
                    }

                    console.log(`âœ… PR #${feature.prNumber} merged. Game mode ${feature.name} removed.`);
                }
            };

            // Complete the restoration after PR is merged
            const completeRestoration = (feature) => {
                // Remove from pending
                const newPending = pendingRestoration.filter(p => p.name !== feature.name);
                setPendingRestoration(newPending);
                localStorage.setItem('pending_restoration', JSON.stringify(newPending));

                // Check if this is a feature flag or game mode
                const isFeatureFlag = featureFlagsData.some(f => f.displayName === feature.name || f.name === feature.name) ||
                                     newFeatureFlags.some(f => f.displayName === feature.name || f.name === feature.name);

                if (isFeatureFlag) {
                    // Remove from removed feature flags
                    const newRemovedFlags = removedFeatureFlags.filter(r => r.name !== feature.name);
                    setRemovedFeatureFlags(newRemovedFlags);
                    localStorage.setItem('removed_feature_flags', JSON.stringify(newRemovedFlags));
                    console.log(`âœ… PR #${feature.prNumber} merged. Feature flag ${feature.name} restored.`);
                    if (feature.replacedBy) {
                        console.log(`   ${feature.replacedBy} was completely removed (not tracked)`);
                    }
                } else {
                    // Remove from removed game modes
                    const newRemoved = removedFeatures.filter(r => r.name !== feature.name);
                    setRemovedFeatures(newRemoved);
                    localStorage.setItem('removed_features', JSON.stringify(newRemoved));

                    // Re-sync game
                    if (connected && gameWindow && gameWindow.FSM && gameWindow.FSM.ModAttacher) {
                        try {
                            console.log(`${feature.name} restored - now available in game`);
                            updateModStates(gameWindow);
                        } catch (err) {
                            console.error('Error syncing game after restoration:', err);
                        }
                    }

                    console.log(`âœ… PR #${feature.prNumber} merged. Game mode ${feature.name} restored.`);
                }
            };

            // Check and complete PR merge for a feature
            const checkAndCompleteMerge = async (feature, type) => {
                setCheckingMerge(feature.name);
                setMergeSuccess(null);
                setManualCheckInProgress(true); // Lock auto-sync
                console.log(`ðŸ” Actively checking for merge on PR #${feature.prNumber}...`);

                const maxAttempts = 10; // 10 attempts over 5 seconds
                const delayBetweenChecks = 500; // 500ms between checks
                let attempt = 0;

                try {
                    // Keep checking until merged or timeout
                    while (attempt < maxAttempts) {
                        attempt++;
                        console.log(`   Attempt ${attempt}/${maxAttempts}: Checking GitHub...`);

                        const isMerged = await checkPRMerged(feature.prNumber);

                        if (isMerged) {
                            console.log(`âœ… PR #${feature.prNumber} is CONFIRMED MERGED on GitHub! (found on attempt ${attempt})`);

                            // Show success message
                            setCheckingMerge(null);
                            setMergeSuccess(feature.name);

                            // Auto-pull git changes to sync local branch with Devin's merged changes
                            try {
                                console.log('ðŸ”„ Auto-pulling git changes after merge...');
                                const pullResponse = await fetch('http://localhost:8000/git-pull', {
                                    method: 'POST'
                                }).catch(() => null);

                                if (pullResponse && pullResponse.ok) {
                                    console.log('âœ… Git pull successful - local branch is now synced');
                                    console.log('ðŸ’¡ Page will reload to apply changes once you close or sync');
                                } else {
                                    console.log('âš ï¸ Auto-pull not available (proxy server not running)');
                                    console.log('ðŸ’¡ Manually run: git pull personal cognition-dashboard-devin-integration');
                                }
                            } catch (err) {
                                console.log('âš ï¸ Auto-pull failed:', err.message);
                            }

                            // DON'T auto-complete - let user see confirmation and manually sync
                            // User can click "Sync" button or reload page to see updated state

                            // Keep success state visible - don't auto-clear
                            setManualCheckInProgress(false); // Unlock auto-sync

                            return true;
                        }

                        // Wait before next check (unless it's the last attempt)
                        if (attempt < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, delayBetweenChecks));
                        }
                    }

                    // Timeout - merge not detected after 5 seconds
                    console.log(`â³ PR #${feature.prNumber} not merged after ${attempt} attempts (5 seconds)`);
                    setCheckingMerge(null);
                    setManualCheckInProgress(false);

                    alert(`PR #${feature.prNumber} for "${feature.name}" hasn't been merged yet.\n\nMake sure the PR is merged on GitHub and try again.`);
                    return false;
                } catch (err) {
                    console.error('âŒ Error checking merge:', err);
                    setCheckingMerge(null);
                    setManualCheckInProgress(false);
                    alert(`Error checking PR status: ${err.message}`);
                    return false;
                }
            };

            const activeFeatures = modsData.filter(m =>
                !removedFeatures.find(r => r.name === m.name) &&
                !enabledFeatures.find(e => e.name === m.name) &&
                !pendingRemoval.find(p => p.name === m.name)
            );
            // Count toggled-on features as "currently enabled"
            const enabledCount = Object.values(modStates).filter(Boolean).length;
            const devinIntegrated = isDevinAPIConfigured();

            return (
                <div className="min-h-screen p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="mb-8">
                            <div className="flex items-start justify-between mb-4">
                                <div>
                                    <h1 className="mario-title">MARIO BROS.</h1>
                                    <h2 className="text-2xl font-semibold text-primary mb-2">Feature Management</h2>
                                    <p className="text-sm text-tertiary">Real-time control and automated workflows</p>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={async () => {
                                            await syncWithGitHub();
                                            // If there was a successful merge check, reload to show updated code
                                            if (mergeSuccess) {
                                                console.log('ðŸ”„ Reloading page to apply merged code changes...');
                                                setTimeout(() => location.reload(), 500);
                                            }
                                        }}
                                        disabled={isSyncing}
                                        className={`px-4 py-2 glass-card rounded-xl transition-all flex items-center gap-2 text-sm font-medium ${isSyncing ? 'opacity-70 cursor-wait' : 'hover:scale-105'}`}
                                        title="Sync with GitHub"
                                    >
                                        <svg className={`w-4 h-4 ${isSyncing ? 'text-blue-300 spinner' : 'text-blue-400'}`} fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                                        </svg>
                                        <span className={`${isSyncing ? 'text-blue-300' : 'text-tertiary'}`}>{isSyncing ? 'Syncing...' : 'Sync'}</span>
                                    </button>
                                    <button
                                        onClick={() => setIsDark(!isDark)}
                                        className="p-3 glass-card rounded-xl transition-all hover:scale-105"
                                        title={isDark ? 'Switch to light mode' : 'Switch to dark mode'}
                                    >
                                        {isDark ? (
                                            <svg className="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                            </svg>
                                        ) : (
                                            <svg className="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                            </svg>
                                        )}
                                    </button>
                                    <button
                                        onClick={openGame}
                                        className="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white text-sm font-medium rounded-xl transition-all shadow-lg hover:shadow-xl hover:scale-105 flex items-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Launch Game
                                    </button>
                                </div>
                            </div>
                            <StatusBadge connected={connected} devinIntegrated={devinIntegrated} />
                        </div>

                        {/* Stats */}
                        <div className="grid grid-cols-3 gap-4 mb-8">
                            <div className="glass-card rounded-2xl p-6">
                                <div className="text-4xl font-semibold text-primary tabular-nums mb-2">{modsData.length + featureFlagsData.length}</div>
                                <div className="text-xs text-tertiary uppercase tracking-wider">Total Features</div>
                            </div>
                            <div className="glass-card rounded-2xl p-6">
                                <div className="text-4xl font-semibold stat-blue text-blue-400 dark:text-blue-400 tabular-nums mb-2">{enabledCount}</div>
                                <div className="text-xs text-tertiary uppercase tracking-wider">Currently Enabled</div>
                            </div>
                            <div className="glass-card rounded-2xl p-6">
                                <div className="text-4xl font-semibold stat-red text-red-400 dark:text-red-400 tabular-nums mb-2">{removedFeatures.length + removedFeatureFlags.length}</div>
                                <div className="text-xs text-tertiary uppercase tracking-wider">Total Removed</div>
                            </div>
                        </div>

                        {/* Tab Navigation */}
                        <div className="tab-container">
                            <button
                                onClick={() => setActiveTab('testing')}
                                className={`tab-button ${activeTab === 'testing' ? 'active' : ''}`}
                            >
                                Testing Game Modes
                            </button>
                            <button
                                onClick={() => setActiveTab('flags')}
                                className={`tab-button ${activeTab === 'flags' ? 'active' : ''}`}
                            >
                                Feature Flags
                            </button>
                        </div>

                        {/* Testing Game Modes Tab */}
                        {activeTab === 'testing' && (
                            <div>

                            {/* Active Features */}
                            <div className="grid grid-cols-2 gap-3 mb-8">
                                {activeFeatures.map(feature => (
                                    <FeatureCard
                                        key={feature.name}
                                        feature={feature}
                                        enabled={modStates[feature.name] || false}
                                        onToggle={toggleMod}
                                        onEnable={null}
                                        onRemove={(f) => setActiveModal({ type: 'remove', feature: f })}
                                        connected={connected}
                                    />
                                ))}
                            </div>

                            {/* Pending Removal PRs - Only Game Modes */}
                            {pendingRemoval.filter(p => !featureFlagsData.some(f => f.name === p.name || f.displayName === p.name)).length > 0 && (
                                <>
                                    <div className="relative mb-4 mt-8">
                                        <div className="absolute inset-0 flex items-center">
                                            <div className="w-full border-t border-yellow-500/30"></div>
                                        </div>
                                        <div className="relative flex justify-center">
                                            <span className="px-4 text-sm font-medium text-yellow-400 glass-card rounded-full py-1 border border-yellow-500/30">
                                                Pending Removal
                                            </span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mb-8">
                                        {pendingRemoval
                                            .filter(p => !featureFlagsData.some(f => f.name === p.name || f.displayName === p.name))
                                            .map(feature => (
                                            <div key={feature.name} className="glass-card rounded-2xl p-4 border-2 border-yellow-500/30">
                                                <div className="flex items-start justify-between mb-3">
                                                    <div className="flex-1">
                                                        <h3 className="text-sm font-semibold text-primary mb-1">{feature.name}</h3>
                                                        <p className="text-xs text-yellow-400 mb-2">
                                                            PR #{feature.prNumber} â€¢ {Math.floor((Date.now() - feature.createdAt) / 60000)}m ago
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <a
                                                        href={feature.prUrl}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="flex-1 px-3 py-1.5 text-xs font-medium text-center text-blue-400 hover:text-blue-300 bg-blue-500/10 hover:bg-blue-500/20 rounded-lg transition-all flex items-center justify-center gap-1"
                                                    >
                                                        <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                                                        </svg>
                                                        View PR
                                                    </a>
                                                    <button
                                                        onClick={() => checkAndCompleteMerge(feature, 'removal')}
                                                        disabled={checkingMerge === feature.name || mergeSuccess === feature.name}
                                                        className={`flex-1 px-3 py-1.5 text-xs font-medium rounded-lg transition-all flex items-center justify-center gap-1 ${
                                                            mergeSuccess === feature.name
                                                                ? 'bg-emerald-500/30 text-emerald-300 border-2 border-emerald-400'
                                                                : checkingMerge === feature.name
                                                                ? 'bg-gray-500/20 text-gray-400 cursor-wait'
                                                                : 'text-emerald-400 hover:text-emerald-300 bg-emerald-500/10 hover:bg-emerald-500/20'
                                                        }`}
                                                    >
                                                        {mergeSuccess === feature.name ? (
                                                            <>
                                                                <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                                </svg>
                                                                Merge Complete!
                                                            </>
                                                        ) : checkingMerge === feature.name ? (
                                                            <>
                                                                <div className="w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full spinner" />
                                                                Checking...
                                                            </>
                                                        ) : (
                                                            'Check Merge'
                                                        )}
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}

                            {/* Pending Restoration PRs */}
                            {pendingRestoration.length > 0 && (
                                <>
                                    <div className="relative mb-4">
                                        <div className="absolute inset-0 flex items-center">
                                            <div className="w-full border-t border-blue-500/30"></div>
                                        </div>
                                        <div className="relative flex justify-center">
                                            <span className="px-4 text-sm font-medium text-blue-400 glass-card rounded-full py-1 border border-blue-500/30">
                                                Pending Restoration
                                            </span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mb-8">
                                        {pendingRestoration.map(feature => (
                                            <div key={feature.name} className="glass-card rounded-2xl p-4 border-2 border-blue-500/30">
                                                <div className="flex items-start justify-between mb-3">
                                                    <div className="flex-1">
                                                        <h3 className="text-sm font-semibold text-primary mb-1">{feature.name}</h3>
                                                        <p className="text-xs text-blue-400 mb-2">
                                                            PR #{feature.prNumber} â€¢ {Math.floor((Date.now() - feature.createdAt) / 60000)}m ago
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <a
                                                        href={feature.prUrl}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="flex-1 px-3 py-1.5 text-xs font-medium text-center text-blue-400 hover:text-blue-300 bg-blue-500/10 hover:bg-blue-500/20 rounded-lg transition-all flex items-center justify-center gap-1"
                                                    >
                                                        <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                                                        </svg>
                                                        View PR
                                                    </a>
                                                    <button
                                                        onClick={() => checkAndCompleteMerge(feature, 'restoration')}
                                                        disabled={checkingMerge === feature.name || mergeSuccess === feature.name}
                                                        className={`flex-1 px-3 py-1.5 text-xs font-medium rounded-lg transition-all flex items-center justify-center gap-1 ${
                                                            mergeSuccess === feature.name
                                                                ? 'bg-emerald-500/30 text-emerald-300 border-2 border-emerald-400'
                                                                : checkingMerge === feature.name
                                                                ? 'bg-gray-500/20 text-gray-400 cursor-wait'
                                                                : 'text-emerald-400 hover:text-emerald-300 bg-emerald-500/10 hover:bg-emerald-500/20'
                                                        }`}
                                                    >
                                                        {mergeSuccess === feature.name ? (
                                                            <>
                                                                <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                                </svg>
                                                                Merge Complete!
                                                            </>
                                                        ) : checkingMerge === feature.name ? (
                                                            <>
                                                                <div className="w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full spinner" />
                                                                Checking...
                                                            </>
                                                        ) : (
                                                            'Check Merge'
                                                        )}
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}

                            {/* Separator - only show if there are removed features */}
                            {removedFeatures.length > 0 && (
                                <div className="relative mb-8">
                                    <div className="absolute inset-0 flex items-center">
                                        <div className="w-full border-t border-white/10 dark:border-white/10 light:border-slate-300"></div>
                                    </div>
                                    <div className="relative flex justify-center">
                                        <span className="px-4 text-sm text-tertiary glass-card rounded-full py-1">
                                            Removed Game Modes
                                        </span>
                                    </div>
                                </div>
                            )}

                            {/* Removed Features - show in same grid layout */}
                            {removedFeatures.length > 0 && (
                                <div className="grid grid-cols-2 gap-3">
                                    {removedFeatures.map(feature => (
                                        <div key={feature.name} className="glass-card rounded-2xl p-4 opacity-60 hover:opacity-100 transition">
                                            <div className="flex items-center justify-between">
                                                <div className="flex-1">
                                                    <h3 className="text-sm font-semibold text-primary mb-1">{feature.name}</h3>
                                                    <p className="text-xs text-tertiary mb-2">
                                                        Removed {Math.floor((Date.now() - feature.removedAt) / 60000)}m ago
                                                    </p>
                                                    <div className="flex items-center gap-3 text-xs text-tertiary">
                                                        <span>PR #{feature.prNumber}</span>
                                                        <span>â€¢</span>
                                                        <span>{feature.lines} lines</span>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => setActiveModal({ type: 'recover', feature })}
                                                    className="px-3 py-1.5 text-xs font-medium btn-recover text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 dark:text-blue-400 dark:hover:text-blue-300 rounded-lg transition-all"
                                                >
                                                    Restore
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            </div>
                        )}

                        {/* Feature Flags Tab */}
                        {activeTab === 'flags' && (
                            <div>
                                {/* Active Feature Flags */}
                                <div className="grid grid-cols-2 gap-3 mb-8">
                                    {/* Hardcoded feature flags */}
                                    {featureFlagsData
                                        .filter(flag => !removedFeatureFlags.find(r => r.name === flag.name) && !pendingRemoval.find(p => p.name === flag.name) && !pendingRestoration.find(p => p.name === flag.name))
                                        .map(flag => (
                                            <FeatureFlagCard
                                                key={flag.name}
                                                feature={flag}
                                                onRemove={(f) => setActiveModal({ type: 'replace-flag', feature: f })}
                                            />
                                        ))
                                    }
                                    {/* Dynamically created feature flags */}
                                    {newFeatureFlags
                                        .filter(flag => !removedFeatureFlags.find(r => r.name === flag.name) && !pendingRemoval.find(p => p.name === flag.name) && !pendingRestoration.find(p => p.name === flag.name))
                                        .map(flag => (
                                            <FeatureFlagCard
                                                key={flag.name}
                                                feature={flag}
                                                onRemove={(f) => setActiveModal({ type: 'replace-flag', feature: f })}
                                            />
                                        ))
                                    }
                                    {(featureFlagsData.filter(flag => !removedFeatureFlags.find(r => r.name === flag.name) && !pendingRemoval.find(p => p.name === flag.name) && !pendingRestoration.find(p => p.name === flag.name)).length === 0 &&
                                      newFeatureFlags.filter(flag => !removedFeatureFlags.find(r => r.name === flag.name) && !pendingRemoval.find(p => p.name === flag.name) && !pendingRestoration.find(p => p.name === flag.name)).length === 0) && (
                                        <div className="col-span-2 glass-card rounded-2xl p-8 text-center">
                                            <div className="text-tertiary text-sm">
                                                No feature flags yet. Feature flags will appear here when added.
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Pending Removal PRs for Feature Flags */}
                                {pendingRemoval.filter(p => featureFlagsData.some(f => f.name === p.name || f.displayName === p.name) || newFeatureFlags.some(f => f.name === p.name || f.displayName === p.name)).length > 0 && (
                                    <>
                                        <div className="relative mb-4 mt-8">
                                            <div className="absolute inset-0 flex items-center">
                                                <div className="w-full border-t border-yellow-500/30"></div>
                                            </div>
                                            <div className="relative flex justify-center">
                                                <span className="px-4 text-sm font-medium text-yellow-400 glass-card rounded-full py-1 border border-yellow-500/30">
                                                    Pending Removal
                                                </span>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-3 mb-8">
                                            {pendingRemoval
                                                .filter(p => featureFlagsData.some(f => f.name === p.name || f.displayName === p.name) || newFeatureFlags.some(f => f.name === p.name || f.displayName === p.name))
                                                .map(feature => (
                                                    <div key={feature.name} className="glass-card rounded-2xl p-4 border-2 border-yellow-500/30">
                                                        <div className="flex items-start justify-between mb-3">
                                                            <div className="flex-1">
                                                                <h3 className="text-sm font-semibold text-primary mb-1">{feature.displayName || feature.name}</h3>
                                                                <p className="text-xs text-yellow-400 mb-2">
                                                                    PR #{feature.prNumber} â€¢ {Math.floor((Date.now() - feature.createdAt) / 60000)}m ago
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <a
                                                                href={feature.prUrl}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="flex-1 px-3 py-1.5 text-xs font-medium text-center text-blue-400 hover:text-blue-300 bg-blue-500/10 hover:bg-blue-500/20 rounded-lg transition-all flex items-center justify-center gap-1"
                                                            >
                                                                <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                                                                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                                                                </svg>
                                                                View PR
                                                            </a>
                                                            <button
                                                                onClick={() => checkAndCompleteMerge(feature, 'removal')}
                                                                disabled={checkingMerge === feature.name || mergeSuccess === feature.name}
                                                                className={`flex-1 px-3 py-1.5 text-xs font-medium rounded-lg transition-all flex items-center justify-center gap-1 ${
                                                                    mergeSuccess === feature.name
                                                                        ? 'bg-emerald-500/30 text-emerald-300 border-2 border-emerald-400'
                                                                        : checkingMerge === feature.name
                                                                        ? 'bg-gray-500/20 text-gray-400 cursor-wait'
                                                                        : 'text-emerald-400 hover:text-emerald-300 bg-emerald-500/10 hover:bg-emerald-500/20'
                                                                }`}
                                                            >
                                                                {mergeSuccess === feature.name ? (
                                                                    <>
                                                                        <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                                                        </svg>
                                                                        Merge Complete!
                                                                    </>
                                                                ) : checkingMerge === feature.name ? (
                                                                    <>
                                                                        <div className="w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full spinner" />
                                                                        Checking...
                                                                    </>
                                                                ) : (
                                                                    'Check Merge'
                                                                )}
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))
                                            }
                                        </div>
                                    </>
                                )}

                                {/* Separator - always show */}
                                <div className="relative mb-4 mt-8">
                                    <div className="absolute inset-0 flex items-center">
                                        <div className="w-full border-t border-white/10 dark:border-white/10 light:border-slate-300"></div>
                                    </div>
                                    <div className="relative flex justify-center">
                                        <span className="px-4 text-sm text-tertiary glass-card rounded-full py-1">
                                            Removed Feature Flags
                                        </span>
                                    </div>
                                </div>

                                {/* Removed Feature Flags */}
                                <div className="grid grid-cols-2 gap-3">
                                    {removedFeatureFlags.length > 0 ? (
                                        removedFeatureFlags.map(flag => (
                                            <div key={flag.name} className="glass-card rounded-2xl p-4 opacity-60 hover:opacity-100 transition">
                                                <div className="flex items-center justify-between">
                                                    <div className="flex-1">
                                                        <h3 className="text-sm font-semibold text-primary mb-1">{flag.displayName || flag.name}</h3>
                                                        <p className="text-xs text-tertiary mb-2">
                                                            Removed {Math.floor((Date.now() - flag.removedAt) / 60000)}m ago
                                                        </p>
                                                        <div className="flex items-center gap-3 text-xs text-tertiary">
                                                            <span>PR #{flag.prNumber}</span>
                                                            <span>â€¢</span>
                                                            <span>{flag.filesAffected?.length || 0} files</span>
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => setActiveModal({ type: 'recover-flag', feature: flag })}
                                                        className="px-3 py-1.5 text-xs font-medium btn-recover text-blue-400 hover:text-blue-300 hover:bg-blue-500/10 dark:text-blue-400 dark:hover:text-blue-300 rounded-lg transition-all"
                                                    >
                                                        Restore
                                                    </button>
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="col-span-2 glass-card rounded-2xl p-8 text-center">
                                            <div className="text-tertiary text-sm">
                                                Removed feature flags will appear here.
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {activeModal && (
                        <AutomationModal
                            feature={activeModal.feature}
                            type={activeModal.type}
                            onComplete={(result) => {
                                const { prNumber, replacementInfo } = result;
                                if (activeModal.type === 'remove') {
                                    handleRemoveComplete(activeModal.feature, prNumber);
                                } else if (activeModal.type === 'enable') {
                                    handleEnableComplete(activeModal.feature, prNumber);
                                } else if (activeModal.type === 'return-to-staging') {
                                    handleReturnToStagingComplete(activeModal.feature, prNumber);
                                } else if (activeModal.type === 'replace-flag') {
                                    handleReplaceComplete(
                                        activeModal.feature,
                                        prNumber,
                                        replacementInfo.oldFlagName,
                                        replacementInfo.newFlagName,
                                        replacementInfo.instruction
                                    );
                                } else if (activeModal.type === 'recover-flag') {
                                    handleRecoverFlagComplete(activeModal.feature, prNumber);
                                } else {
                                    handleRecoverComplete(activeModal.feature, prNumber);
                                }
                            }}
                            onCancel={() => setActiveModal(null)}
                        />
                    )}
                </div>
            );
        }

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
