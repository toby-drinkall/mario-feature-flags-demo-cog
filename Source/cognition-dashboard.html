<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognition Demo Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .game-link {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .game-link:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .mods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .mod-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }

        .mod-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        .mod-card.active {
            border: 3px solid #667eea;
            background: #f0f4ff;
        }

        .mod-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mod-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .mod-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .mod-author {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 33px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-enabled {
            background: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .stat-box {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>ðŸ§  Cognition Demo Dashboard</h1>
            <p>Control and manage game modifications in real-time</p>
            <a href="index.html" class="game-link" id="gameLink" onclick="openGameWindow(event); return false;">ðŸŽ® Open Game</a>
            <div id="connectionStatus" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;">
                <span id="statusText"></span>
            </div>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="totalMods">0</div>
                <div class="stat-label">Total Mods</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="enabledMods">0</div>
                <div class="stat-label">Enabled Mods</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="disabledMods">0</div>
                <div class="stat-label">Disabled Mods</div>
            </div>
        </div>

        <div class="mods-grid" id="modsGrid"></div>
    </div>

    <script>
        // Track game window reference
        let gameWindow = null;

        // Open game in a popup window that we can control
        function openGameWindow(event) {
            if (event) event.preventDefault();

            // Open game in a new window that we can access
            gameWindow = window.open(
                'index.html',
                'FullScreenMario',
                'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no'
            );

            // Check when game is loaded
            if (gameWindow) {
                const checkLoaded = setInterval(function() {
                    try {
                        if (gameWindow.FSM && gameWindow.FSM.ModAttacher) {
                            console.log('âœ“ Game window loaded and FSM available');
                            updateConnectionStatus();
                            clearInterval(checkLoaded);
                        }
                    } catch (e) {
                        // Can't access yet, keep trying
                    }
                }, 100);
            }
        }

        // Check if we can communicate with game
        function checkGameConnection() {
            try {
                return gameWindow && !gameWindow.closed && gameWindow.FSM && gameWindow.FSM.ModAttacher;
            } catch (e) {
                return false;
            }
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const isConnected = checkGameConnection();

            statusDiv.style.display = 'block';
            if (isConnected) {
                statusDiv.style.background = '#d4edda';
                statusText.textContent = 'âœ“ Connected to Game - Real-time control active';
            } else {
                statusDiv.style.background = '#fff3cd';
                statusText.textContent = 'âš  Click "Open Game" button to enable real-time control';
            }
        }

        // FullScreenMario mod definitions (from mods.js)
        const modsList = [
            {
                name: "Bouncy Bounce",
                description: "Mario landing causes him to jump.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Dark is the Night",
                description: "The night is darkest before the dawn, but I promise you: the dawn is coming.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Earthquake!",
                description: "Mario landing causes everything else to jump.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Gradient Skies",
                description: "The background becomes a smooth gradient.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Hard Mode",
                description: "Goombas are replaced with Beetles, Koopas move faster, and Piranha Plants are less predictable.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "High Speed",
                description: "Mario runs 14x faster.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Infinite Lives",
                description: "Mario never loses lives.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Invincibility",
                description: "Mario is always star powered.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Parallax Clouds",
                description: "Clouds scroll at 70% speed.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Low Gravity",
                description: "Gravity is reduced significantly.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Luigi",
                description: "Play as Luigi instead of Mario.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Palette Swap",
                description: "Random color palettes are applied.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "QCount",
                description: "Press Q to spawn enemies.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            },
            {
                name: "Super Fireballs",
                description: "Fireballs can destroy blocks.",
                author: { name: "Josh Goldberg", email: "josh@fullscreenmario.com" }
            }
        ];

        // Get mod state from localStorage (same as game uses)
        function getModState(modName) {
            const key = `FullScreenMario::mods::mod::${modName}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored).enabled : false;
        }

        // Set mod state in localStorage
        function setModState(modName, enabled) {
            const key = `FullScreenMario::mods::mod::${modName}`;
            localStorage.setItem(key, JSON.stringify({ enabled: enabled }));
        }

        // Toggle mod
        function toggleMod(modName, toggleElement, cardElement) {
            // Check if game window is available
            if (!checkGameConnection()) {
                alert('Game window not connected! Click "Open Game" button first.');
                return;
            }

            try {
                // DIRECT CALL - Same as original UI did!
                console.log('Dashboard: Calling toggleMod directly:', modName);
                gameWindow.FSM.ModAttacher.toggleMod(modName);

                // Update UI to match
                const newState = gameWindow.FSM.ModAttacher.getMod(modName).enabled;
                setModState(modName, newState);

                if (newState) {
                    toggleElement.classList.add('active');
                    cardElement.classList.add('active');
                } else {
                    toggleElement.classList.remove('active');
                    cardElement.classList.remove('active');
                }

                updateStats();
                console.log('âœ“ Mod toggled successfully to:', newState);
            } catch (err) {
                console.error('Error toggling mod:', err);
                alert('Failed to toggle mod. Make sure game is running.');
            }
        }

        // Update statistics
        function updateStats() {
            const total = modsList.length;
            let enabled = 0;

            modsList.forEach(mod => {
                if (getModState(mod.name)) {
                    enabled++;
                }
            });

            document.getElementById('totalMods').textContent = total;
            document.getElementById('enabledMods').textContent = enabled;
            document.getElementById('disabledMods').textContent = total - enabled;
        }

        // Render mods
        function renderMods() {
            const grid = document.getElementById('modsGrid');
            grid.innerHTML = '';

            modsList.forEach(mod => {
                const isEnabled = getModState(mod.name);

                const card = document.createElement('div');
                card.className = 'mod-card' + (isEnabled ? ' active' : '');

                const toggle = document.createElement('div');
                toggle.className = 'toggle-switch' + (isEnabled ? ' active' : '');
                toggle.onclick = () => toggleMod(mod.name, toggle, card);

                card.innerHTML = `
                    <div class="mod-header">
                        <div class="mod-title">${mod.name}</div>
                    </div>
                    <div class="mod-description">${mod.description}</div>
                    <div class="mod-author">by ${mod.author.name}</div>
                    <span class="status-badge ${isEnabled ? 'status-enabled' : 'status-disabled'}">
                        ${isEnabled ? 'âœ“ Enabled' : 'âœ— Disabled'}
                    </span>
                `;

                card.querySelector('.mod-header').appendChild(toggle);
                grid.appendChild(card);
            });

            updateStats();
        }

        // Initialize
        renderMods();
        updateConnectionStatus();

        // Update every second to sync with game if it changes mods
        setInterval(function() {
            renderMods();
            updateConnectionStatus();
        }, 1000);

        // Listen for responses from game
        window.addEventListener('storage', function(e) {
            if (e.key === 'FSM::dashboard::response') {
                console.log('Game response received');
                updateConnectionStatus();
            }
        });
    </script>
</body>
</html>
