<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognition Demo Dashboard</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom shadcn-inspired styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #fafafa;
            color: #0a0a0a;
        }

        /* Toggle Switch Component (shadcn style) */
        .toggle-root {
            position: relative;
            width: 44px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 2px solid transparent;
        }

        .toggle-root:hover {
            background: #d1d5db;
        }

        .toggle-root.active {
            background: #2563eb;
        }

        .toggle-root.active:hover {
            background: #1d4ed8;
        }

        .toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: left 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .toggle-root.active .toggle-thumb {
            left: 22px;
        }

        /* Card shadow */
        .card-shadow {
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Status badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-connected {
            background: #dcfce7;
            color: #166534;
        }

        .status-disconnected {
            background: #fef3c7;
            color: #92400e;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Mod definitions
        const modsList = [
            { name: "Bouncy Bounce", description: "Mario landing causes him to jump." },
            { name: "Dark is the Night", description: "Dark theme visual." },
            { name: "Earthquake!", description: "Mario landing causes everything else to jump." },
            { name: "Gradient Skies", description: "Smooth gradient backgrounds." },
            { name: "Hard Mode", description: "Goombas replaced with Beetles, faster enemies." },
            { name: "High Speed", description: "Mario runs 14x faster." },
            { name: "Infinite Lives", description: "Mario never loses lives." },
            { name: "Invincibility", description: "Always star powered." },
            { name: "Parallax Clouds", description: "Clouds scroll at 70% speed." },
            { name: "Low Gravity", description: "Reduced gravity." },
            { name: "Luigi", description: "Play as Luigi." },
            { name: "Tilt Gravity", description: "Device motion controls gravity." },
            { name: "Palette Swap", description: "Random color palettes." },
            { name: "QCount", description: "Press Q to spawn enemies." },
            { name: "Super Fireballs", description: "Fireballs destroy blocks." },
            { name: "Trip of Acid", description: "Screen trails effect." }
        ];

        // Toggle Component
        function Toggle({ enabled, onChange }) {
            return (
                <div
                    className={`toggle-root ${enabled ? 'active' : ''}`}
                    onClick={onChange}
                    role="switch"
                    aria-checked={enabled}
                >
                    <div className="toggle-thumb"></div>
                </div>
            );
        }

        // Feature Card Component
        function FeatureCard({ mod, enabled, onToggle, connected }) {
            return (
                <div className="bg-white rounded-lg border border-gray-200 p-4 flex items-center justify-between hover:border-gray-300 transition-colors card-shadow">
                    <div className="flex-1">
                        <h3 className="text-sm font-semibold text-gray-900">{mod.name}</h3>
                    </div>
                    <Toggle enabled={enabled} onChange={() => connected && onToggle(mod.name)} />
                </div>
            );
        }

        // Main Dashboard Component
        function Dashboard() {
            const [gameWindow, setGameWindow] = useState(null);
            const [connected, setConnected] = useState(false);
            const [modStates, setModStates] = useState({});
            const checkIntervalRef = useRef(null);

            // Check game connection
            const checkConnection = () => {
                try {
                    const isConnected = gameWindow && !gameWindow.closed && gameWindow.FSM && gameWindow.FSM.ModAttacher;
                    setConnected(isConnected);
                    return isConnected;
                } catch (e) {
                    setConnected(false);
                    return false;
                }
            };

            // Open game window
            const openGame = () => {
                const win = window.open(
                    'index.html',
                    'FullScreenMario',
                    'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no'
                );

                setGameWindow(win);

                // Poll for game readiness
                const checkLoaded = setInterval(() => {
                    try {
                        if (win.FSM && win.FSM.ModAttacher) {
                            console.log('✓ Game loaded and ready');
                            clearInterval(checkLoaded);
                            updateModStates(win);
                        }
                    } catch (e) {}
                }, 100);
            };

            // Update mod states from game
            const updateModStates = (win) => {
                if (!win || !win.FSM || !win.FSM.ModAttacher) return;

                const states = {};
                modsList.forEach(mod => {
                    try {
                        const modData = win.FSM.ModAttacher.getMod(mod.name);
                        states[mod.name] = modData ? modData.enabled : false;
                    } catch (e) {
                        states[mod.name] = false;
                    }
                });
                setModStates(states);
            };

            // Toggle mod
            const toggleMod = (modName) => {
                if (!checkConnection()) {
                    alert('Game window not connected! Click "Launch Game" button first.');
                    return;
                }

                try {
                    gameWindow.FSM.ModAttacher.toggleMod(modName);
                    const newState = gameWindow.FSM.ModAttacher.getMod(modName).enabled;

                    setModStates(prev => ({
                        ...prev,
                        [modName]: newState
                    }));

                    console.log(`✓ ${modName} toggled to ${newState}`);
                } catch (err) {
                    console.error('Error toggling mod:', err);
                }
            };

            // Setup connection polling
            useEffect(() => {
                checkIntervalRef.current = setInterval(() => {
                    checkConnection();
                    if (gameWindow) {
                        updateModStates(gameWindow);
                    }
                }, 1000);

                return () => {
                    if (checkIntervalRef.current) {
                        clearInterval(checkIntervalRef.current);
                    }
                };
            }, [gameWindow]);

            const enabledCount = Object.values(modStates).filter(Boolean).length;

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-6 py-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">Cognition Demo Dashboard</h1>
                                    <p className="text-sm text-gray-600 mt-1">Real-time feature management and control</p>
                                </div>
                                <button
                                    onClick={openGame}
                                    className="px-6 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
                                >
                                    Launch Game
                                </button>
                            </div>

                            {/* Connection Status */}
                            <div className="mt-4">
                                <span className={`status-badge ${connected ? 'status-connected' : 'status-disconnected'}`}>
                                    <span className={connected ? '' : 'pulse'}>●</span>
                                    {connected ? 'Connected to Game' : 'Waiting for Connection'}
                                </span>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-6 py-8">
                        {/* Stats */}
                        <div className="grid grid-cols-3 gap-4 mb-8">
                            <div className="bg-white rounded-lg border border-gray-200 p-6 card-shadow">
                                <div className="text-3xl font-bold text-gray-900">{modsList.length}</div>
                                <div className="text-sm text-gray-600 mt-1">Total Features</div>
                            </div>
                            <div className="bg-white rounded-lg border border-gray-200 p-6 card-shadow">
                                <div className="text-3xl font-bold text-blue-600">{enabledCount}</div>
                                <div className="text-sm text-gray-600 mt-1">Active Features</div>
                            </div>
                            <div className="bg-white rounded-lg border border-gray-200 p-6 card-shadow">
                                <div className="text-3xl font-bold text-gray-400">{modsList.length - enabledCount}</div>
                                <div className="text-sm text-gray-600 mt-1">Inactive Features</div>
                            </div>
                        </div>

                        {/* Features Section */}
                        <section className="mb-12">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-semibold text-gray-900">Features</h2>
                                <span className="text-sm text-gray-500">{modsList.length} total</span>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {modsList.map(mod => (
                                    <FeatureCard
                                        key={mod.name}
                                        mod={mod}
                                        enabled={modStates[mod.name] || false}
                                        onToggle={toggleMod}
                                        connected={connected}
                                    />
                                ))}
                            </div>
                        </section>

                        {/* Feature Flag Management Section (Draft) */}
                        <section>
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-semibold text-gray-900">Feature Flag Management</h2>
                                <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Coming Soon</span>
                            </div>
                            <div className="bg-white rounded-lg border border-gray-200 p-8 card-shadow">
                                <div className="text-center text-gray-500">
                                    <svg className="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                    <h3 className="text-sm font-medium text-gray-900 mb-2">Automated Feature Flag Removal</h3>
                                    <p className="text-sm text-gray-600 max-w-md mx-auto">
                                        Track Devin automation status for feature flag cleanup and pull request generation. This section will display real-time progress updates.
                                    </p>
                                </div>
                            </div>
                        </section>
                    </main>
                </div>
            );
        }

        // Render app
        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
